# é€šè¿‡é…ç½®å…³é—­ä¸å¿…è¦æ¨¡å—çš„ä¼˜åŒ–æ–¹æ¡ˆ

## ä¸€ã€å½“å‰ç³»ç»Ÿå¯åŠ¨æµç¨‹åˆ†æ

### 1. æœåŠ¡åˆ—è¡¨

å½“å‰ç³»ç»Ÿå¯åŠ¨æ—¶ä¼šåŠ è½½ä»¥ä¸‹æœåŠ¡ï¼š

| æœåŠ¡åç§° | å¯ç”¨çŠ¶æ€æ§åˆ¶ | å…³é”®ç¨‹åº¦ | å¯åŠ¨é¡ºåº |
|---------|-------------|---------|---------|
| system_core | ç¡¬ç¼–ç ä¸ºTrue | å…³é”® | 0 |
| nacos_registration | settings.NACOS_ENABLED | éå…³é”® | 1 |
| enterprise_minio_services | ç¡¬ç¼–ç ä¸ºTrue | éå…³é”® | 2 |
| unified_compensation | settings.COMPENSATION_AUTO_START | å…³é”® | 3 |

### 2. ç³»ç»Ÿæ ¸å¿ƒåˆå§‹åŒ–å†…å®¹

`system_core`æœåŠ¡ä¼šæ‰§è¡Œä»¥ä¸‹åˆå§‹åŒ–æ­¥éª¤ï¼š

1. åˆ›å»ºæ•°æ®åº“è¡¨
2. åŒæ­¥Tritonæ¨¡å‹åˆ°æ•°æ®åº“
3. åˆå§‹åŒ–æŠ€èƒ½ç®¡ç†å™¨
4. åˆå§‹åŒ–AIä»»åŠ¡æ‰§è¡Œå™¨
5. å¯åŠ¨SSEè¿æ¥ç®¡ç†å™¨
6. åˆå§‹åŒ–Redisè¿æ¥
7. å¯åŠ¨é¢„è­¦å¤åˆ¤é˜Ÿåˆ—æœåŠ¡
8. å¯åŠ¨LLMä»»åŠ¡æ‰§è¡Œå™¨

### 3. æœ¬åœ°æµ‹è¯•éœ€æ±‚

ç”¨æˆ·å¸Œæœ›åœ¨æœ¬åœ°æµ‹è¯•æ—¶åªä¿ç•™ï¼š
- Webæ¡†æ¶
- æ•°æ®åº“è¿æ¥

æ‰€æœ‰å…¶ä»–æœåŠ¡éƒ½åº”è¯¥å¯ä»¥é€šè¿‡é…ç½®å…³é—­ã€‚

## äºŒã€ä¼˜åŒ–æ–¹æ¡ˆ

### 1. æ·»åŠ é…ç½®é¡¹

åœ¨`config.py`ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®é¡¹ï¼š

| é…ç½®é¡¹åç§° | é»˜è®¤å€¼ | æè¿° |
|-----------|--------|------|
| SYSTEM_CORE_ENABLED | True | æ˜¯å¦å¯ç”¨ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡ |
| TRITON_SYNC_ENABLED | True | æ˜¯å¦å¯ç”¨Tritonæ¨¡å‹åŒæ­¥ |
| SKILL_MANAGER_ENABLED | True | æ˜¯å¦å¯ç”¨æŠ€èƒ½ç®¡ç†å™¨ |
| AI_TASK_EXECUTOR_ENABLED | True | æ˜¯å¦å¯ç”¨AIä»»åŠ¡æ‰§è¡Œå™¨ |
| SSE_MANAGER_ENABLED | True | æ˜¯å¦å¯ç”¨SSEè¿æ¥ç®¡ç†å™¨ |
| REDIS_ENABLED | True | æ˜¯å¦å¯ç”¨Redisè¿æ¥ |
| LLM_TASK_EXECUTOR_ENABLED | True | æ˜¯å¦å¯ç”¨LLMä»»åŠ¡æ‰§è¡Œå™¨ |
| MINIO_ENABLED | True | æ˜¯å¦å¯ç”¨MinIOæœåŠ¡é›†ç¾¤ |

### 2. ä¿®æ”¹æœåŠ¡åˆ—è¡¨

ä¿®æ”¹`system_startup.py`ä¸­çš„æœåŠ¡åˆ—è¡¨ï¼Œä½¿ç”¨é…ç½®é¡¹æ§åˆ¶æœåŠ¡çš„å¯ç”¨çŠ¶æ€ï¼š

```python
self.services = [
    {
        "name": "system_core",
        "display_name": "ç³»ç»Ÿæ ¸å¿ƒåˆå§‹åŒ–",
        "start_func": self._initialize_system_core,
        "stop_func": None,
        "enabled": settings.SYSTEM_CORE_ENABLED,
        "critical": True,
        "startup_order": 0
    },
    {
        "name": "nacos_registration",
        "display_name": "NacosæœåŠ¡æ³¨å†Œ",
        "start_func": self._register_to_nacos,
        "stop_func": self._deregister_from_nacos,
        "enabled": settings.NACOS_ENABLED,
        "critical": False,
        "startup_order": 1
    },
    {
        "name": "enterprise_minio_services",
        "display_name": "ä¼ä¸šçº§MinIOæœåŠ¡é›†ç¾¤",
        "start_func": self._initialize_enterprise_minio_services,
        "stop_func": self._shutdown_enterprise_minio_services,
        "enabled": settings.MINIO_ENABLED,
        "critical": False,
        "startup_order": 2
    },
    {
        "name": "unified_compensation",
        "display_name": "ç»Ÿä¸€è¡¥å¿æœåŠ¡",
        "start_func": start_unified_compensation,
        "stop_func": stop_unified_compensation,
        "enabled": settings.COMPENSATION_AUTO_START,
        "critical": True,
        "startup_order": 3
    }
]
```

### 3. ä¿®æ”¹ç³»ç»Ÿæ ¸å¿ƒåˆå§‹åŒ–æ–¹æ³•

ä¿®æ”¹`_initialize_system_core`æ–¹æ³•ï¼Œæ ¹æ®é…ç½®é¡¹è·³è¿‡ä¸å¿…è¦çš„åˆå§‹åŒ–æ­¥éª¤ï¼š

```python
async def _initialize_system_core(self):
    # ... ç°æœ‰ä»£ç  ...
    
    # 2. åŒæ­¥Tritonæ¨¡å‹åˆ°æ•°æ®åº“ï¼ˆå¦‚æœTritonå¯ç”¨ä¸”å¯ç”¨ï¼‰
    if settings.TRITON_SYNC_ENABLED:
        logger.info("ğŸ”„ æ­£åœ¨åŒæ­¥Tritonæ¨¡å‹åˆ°æ•°æ®åº“...")
        try:
            result = sync_models_from_triton()
            logger.info(f"âœ… æ¨¡å‹åŒæ­¥ç»“æœ: {result['message']}")
        except Exception as e:
            logger.warning(f"âš ï¸ æ¨¡å‹åŒæ­¥å¤±è´¥ï¼ˆTritonå¯èƒ½æœªå¯åŠ¨ï¼‰: {str(e)}")
            logger.info("ğŸ”— Tritonå®¢æˆ·ç«¯å·²é…ç½®è‡ªåŠ¨é‡è¿ï¼Œé¦–æ¬¡è°ƒç”¨æ—¶ä¼šè‡ªåŠ¨è¿æ¥")
    else:
        logger.info("â­ï¸ è·³è¿‡Tritonæ¨¡å‹åŒæ­¥ï¼ˆå·²ç¦ç”¨ï¼‰")
    
    # 3. åˆå§‹åŒ–æŠ€èƒ½ç®¡ç†å™¨
    if settings.SKILL_MANAGER_ENABLED:
        logger.info("ğŸ¯ åˆå§‹åŒ–æŠ€èƒ½ç®¡ç†å™¨...")
        # ... ç°æœ‰ä»£ç  ...
    else:
        logger.info("â­ï¸ è·³è¿‡æŠ€èƒ½ç®¡ç†å™¨åˆå§‹åŒ–ï¼ˆå·²ç¦ç”¨ï¼‰")
    
    # 4. åˆå§‹åŒ–AIä»»åŠ¡æ‰§è¡Œå™¨
    if settings.AI_TASK_EXECUTOR_ENABLED:
        logger.info("ğŸ¤– åˆå§‹åŒ–AIä»»åŠ¡æ‰§è¡Œå™¨...")
        # ... ç°æœ‰ä»£ç  ...
    else:
        logger.info("â­ï¸ è·³è¿‡AIä»»åŠ¡æ‰§è¡Œå™¨åˆå§‹åŒ–ï¼ˆå·²ç¦ç”¨ï¼‰")
    
    # 5. å¯åŠ¨SSEè¿æ¥ç®¡ç†å™¨
    if settings.SSE_MANAGER_ENABLED:
        logger.info("ğŸ“¡ å¯åŠ¨SSEè¿æ¥ç®¡ç†å™¨...")
        # ... ç°æœ‰ä»£ç  ...
    else:
        logger.info("â­ï¸ è·³è¿‡SSEè¿æ¥ç®¡ç†å™¨å¯åŠ¨ï¼ˆå·²ç¦ç”¨ï¼‰")
    
    # 6. åˆå§‹åŒ–Redisè¿æ¥
    if settings.REDIS_ENABLED:
        logger.info("ğŸ”§ åˆå§‹åŒ–Redisè¿æ¥...")
        # ... ç°æœ‰ä»£ç  ...
    else:
        logger.info("â­ï¸ è·³è¿‡Redisè¿æ¥åˆå§‹åŒ–ï¼ˆå·²ç¦ç”¨ï¼‰")
    
    # 7. å¯åŠ¨é¢„è­¦å¤åˆ¤é˜Ÿåˆ—æœåŠ¡
    # å·²ç»ä½¿ç”¨settings.ALERT_REVIEW_QUEUE_ENABLEDæ§åˆ¶
    
    # 8. å¯åŠ¨LLMä»»åŠ¡æ‰§è¡Œå™¨
    if settings.LLM_TASK_EXECUTOR_ENABLED:
        logger.info("ğŸš€ å¯åŠ¨LLMä»»åŠ¡æ‰§è¡Œå™¨...")
        # ... ç°æœ‰ä»£ç  ...
    else:
        logger.info("â­ï¸ è·³è¿‡LLMä»»åŠ¡æ‰§è¡Œå™¨å¯åŠ¨ï¼ˆå·²ç¦ç”¨ï¼‰")
    
    # ... ç°æœ‰ä»£ç  ...
```

### 4. ä¿®æ”¹å…³é—­æ–¹æ³•

ä¿®æ”¹`_shutdown_system_core`æ–¹æ³•ï¼Œæ ¹æ®é…ç½®é¡¹è·³è¿‡ä¸å¿…è¦çš„å…³é—­æ­¥éª¤ï¼š

```python
async def _shutdown_system_core(self):
    logger.info("ğŸ”§ å…³é—­ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡...")
    
    # å…³é—­LLMä»»åŠ¡æ‰§è¡Œå™¨
    if settings.LLM_TASK_EXECUTOR_ENABLED:
        try:
            from app.services.llm_task_executor import llm_task_executor
            llm_task_executor.stop()
            logger.info("âœ… LLMä»»åŠ¡æ‰§è¡Œå™¨å·²å…³é—­")
        except Exception as e:
            logger.error(f"âŒ å…³é—­LLMä»»åŠ¡æ‰§è¡Œå™¨å¤±è´¥: {str(e)}")
    
    # å…³é—­é¢„è­¦å¤åˆ¤é˜Ÿåˆ—æœåŠ¡
    # å·²ç»ä½¿ç”¨settings.ALERT_REVIEW_QUEUE_ENABLEDæ§åˆ¶
    
    # å…³é—­Redisè¿æ¥
    if settings.REDIS_ENABLED:
        try:
            from app.services.redis_client import close_redis
            close_redis()
            logger.info("âœ… Redisè¿æ¥å·²å…³é—­")
        except Exception as e:
            logger.error(f"âŒ å…³é—­Redisè¿æ¥å¤±è´¥: {str(e)}")
    
    # å…³é—­SSEè¿æ¥ç®¡ç†å™¨
    if settings.SSE_MANAGER_ENABLED:
        try:
            await sse_manager.stop()
            logger.info("âœ… SSEè¿æ¥ç®¡ç†å™¨å·²å…³é—­")
        except Exception as e:
            logger.error(f"âŒ å…³é—­SSEè¿æ¥ç®¡ç†å™¨å¤±è´¥: {str(e)}")
    
    # å…³é—­RabbitMQè¿æ¥
    # éœ€è¦æ·»åŠ é…ç½®é¡¹æ§åˆ¶
    
    # å…³é—­æŠ€èƒ½ç®¡ç†å™¨
    if settings.SKILL_MANAGER_ENABLED:
        try:
            skill_manager.cleanup_all()
            logger.info("âœ… æŠ€èƒ½ç®¡ç†å™¨å·²æ¸…ç†")
        except Exception as e:
            logger.error(f"âŒ æ¸…ç†æŠ€èƒ½ç®¡ç†å™¨å¤±è´¥: {str(e)}")
    
    # å…³é—­ä»»åŠ¡æ‰§è¡Œå™¨
    if settings.AI_TASK_EXECUTOR_ENABLED:
        try:
            task_executor.shutdown()
            logger.info("âœ… AIä»»åŠ¡æ‰§è¡Œå™¨å·²å…³é—­")
        except Exception as e:
            logger.error(f"âŒ å…³é—­AIä»»åŠ¡æ‰§è¡Œå™¨å¤±è´¥: {str(e)}")
    
    # å…³é—­å…¨å±€å¸§è¯»å–å™¨ç®¡ç†æ± 
    # éœ€è¦æ·»åŠ é…ç½®é¡¹æ§åˆ¶
```

## ä¸‰ã€æœ¬åœ°æµ‹è¯•é…ç½®ç¤ºä¾‹

### 1. åˆ›å»º `.env` æ–‡ä»¶

```env
# åŸºæœ¬é…ç½®
DEBUG=True
LOG_LEVEL=INFO

# æ•°æ®åº“é…ç½®
MYSQL_SERVER=127.0.0.1
MYSQL_USER=root
MYSQL_PASSWORD=root
MYSQL_DB=smart_vision
MYSQL_PORT=3306

# æœåŠ¡é…ç½® - åªä¿ç•™å¿…è¦æœåŠ¡
SYSTEM_CORE_ENABLED=True
NACOS_ENABLED=False
MINIO_ENABLED=False
COMPENSATION_AUTO_START=False

# ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡é…ç½® - åªä¿ç•™æ•°æ®åº“åˆå§‹åŒ–
TRITON_SYNC_ENABLED=False
SKILL_MANAGER_ENABLED=False
AI_TASK_EXECUTOR_ENABLED=False
SSE_MANAGER_ENABLED=False
REDIS_ENABLED=False
LLM_TASK_EXECUTOR_ENABLED=False
ALERT_REVIEW_QUEUE_ENABLED=False
```

### 2. å¯åŠ¨åº”ç”¨

```bash
python -m app.main
```

## å››ã€é¢„æœŸæ•ˆæœ

é€šè¿‡ä»¥ä¸Šé…ç½®ï¼Œç³»ç»Ÿå¯åŠ¨æ—¶å°†åªæ‰§è¡Œä»¥ä¸‹å¿…è¦æ­¥éª¤ï¼š
1. åˆå§‹åŒ–FastAPIåº”ç”¨
2. åˆ›å»ºæ•°æ®åº“è¡¨
3. æ³¨å†ŒAPIè·¯ç”±
4. å¯åŠ¨HTTPæœåŠ¡å™¨

æ‰€æœ‰éå¿…è¦çš„æœåŠ¡éƒ½å°†è¢«å…³é—­ï¼Œä»è€Œå‡å°‘ä¾èµ–å’Œå¯åŠ¨æ—¶é—´ï¼Œé€‚åˆæœ¬åœ°RBACé€»è¾‘æµ‹è¯•ã€‚

## äº”ã€å…·ä½“ä»£ç ä¿®æ”¹

### 1. ä¿®æ”¹ `config.py`

æ·»åŠ ä»¥ä¸‹é…ç½®é¡¹ï¼š

```python
# æœåŠ¡æ§åˆ¶é…ç½®
SYSTEM_CORE_ENABLED: bool = Field(default=True, description="æ˜¯å¦å¯ç”¨ç³»ç»Ÿæ ¸å¿ƒæœåŠ¡")
TRITON_SYNC_ENABLED: bool = Field(default=True, description="æ˜¯å¦å¯ç”¨Tritonæ¨¡å‹åŒæ­¥")
SKILL_MANAGER_ENABLED: bool = Field(default=True, description="æ˜¯å¦å¯ç”¨æŠ€èƒ½ç®¡ç†å™¨")
AI_TASK_EXECUTOR_ENABLED: bool = Field(default=True, description="æ˜¯å¦å¯ç”¨AIä»»åŠ¡æ‰§è¡Œå™¨")
SSE_MANAGER_ENABLED: bool = Field(default=True, description="æ˜¯å¦å¯ç”¨SSEè¿æ¥ç®¡ç†å™¨")
REDIS_ENABLED: bool = Field(default=True, description="æ˜¯å¦å¯ç”¨Redisè¿æ¥")
LLM_TASK_EXECUTOR_ENABLED: bool = Field(default=True, description="æ˜¯å¦å¯ç”¨LLMä»»åŠ¡æ‰§è¡Œå™¨")
MINIO_ENABLED: bool = Field(default=True, description="æ˜¯å¦å¯ç”¨MinIOæœåŠ¡é›†ç¾¤")
```

### 2. ä¿®æ”¹ `system_startup.py`

#### ï¼ˆ1ï¼‰ä¿®æ”¹æœåŠ¡åˆ—è¡¨

```python
self.services = [
    {
        "name": "system_core",
        "display_name": "ç³»ç»Ÿæ ¸å¿ƒåˆå§‹åŒ–",
        "start_func": self._initialize_system_core,
        "stop_func": None,
        "enabled": settings.SYSTEM_CORE_ENABLED,
        "critical": True,
        "startup_order": 0
    },
    {
        "name": "nacos_registration",
        "display_name": "NacosæœåŠ¡æ³¨å†Œ",
        "start_func": self._register_to_nacos,
        "stop_func": self._deregister_from_nacos,
        "enabled": settings.NACOS_ENABLED,
        "critical": False,
        "startup_order": 1
    },
    {
        "name": "enterprise_minio_services",
        "display_name": "ä¼ä¸šçº§MinIOæœåŠ¡é›†ç¾¤",
        "start_func": self._initialize_enterprise_minio_services,
        "stop_func": self._shutdown_enterprise_minio_services,
        "enabled": settings.MINIO_ENABLED,
        "critical": False,
        "startup_order": 2
    },
    {
        "name": "unified_compensation",
        "display_name": "ç»Ÿä¸€è¡¥å¿æœåŠ¡",
        "start_func": start_unified_compensation,
        "stop_func": stop_unified_compensation,
        "enabled": settings.COMPENSATION_AUTO_START,
        "critical": True,
        "startup_order": 3
    }
]
```

#### ï¼ˆ2ï¼‰ä¿®æ”¹ `_initialize_system_core` æ–¹æ³•

æ ¹æ®é…ç½®é¡¹è·³è¿‡ä¸å¿…è¦çš„åˆå§‹åŒ–æ­¥éª¤ã€‚

#### ï¼ˆ3ï¼‰ä¿®æ”¹ `_shutdown_system_core` æ–¹æ³•

æ ¹æ®é…ç½®é¡¹è·³è¿‡ä¸å¿…è¦çš„å…³é—­æ­¥éª¤ã€‚

## å…­ã€åç»­ä¼˜åŒ–å»ºè®®

1. **æ·»åŠ æ›´å¤šé…ç½®é¡¹**ï¼šä¸ºæ‰€æœ‰æœåŠ¡æ·»åŠ é…ç½®é¡¹ï¼Œå…è®¸æ›´ç²¾ç»†çš„æ§åˆ¶
2. **ä¼˜åŒ–ä»£ç ç»“æ„**ï¼šå°†é…ç½®é¡¹åˆ†ç»„ï¼Œæé«˜ä»£ç çš„å¯è¯»æ€§å’Œç»´æŠ¤æ€§
3. **æ·»åŠ é…ç½®éªŒè¯**ï¼šç¡®ä¿é…ç½®é¡¹çš„åˆæ³•æ€§ï¼Œé¿å…æ— æ•ˆé…ç½®
4. **æä¾›é…ç½®æ¨¡æ¿**ï¼šä¸ºä¸åŒåœºæ™¯æä¾›é¢„å®šä¹‰çš„é…ç½®æ¨¡æ¿
5. **æ·»åŠ æ–‡æ¡£**ï¼šä¸ºæ¯ä¸ªé…ç½®é¡¹æ·»åŠ è¯¦ç»†çš„æè¿°å’Œä½¿ç”¨è¯´æ˜

é€šè¿‡ä»¥ä¸Šä¼˜åŒ–ï¼Œå¯ä»¥å®ç°é€šè¿‡é…ç½®å…³é—­ä¸å¿…è¦çš„æ¨¡å—ï¼Œåªä¿ç•™webæ¡†æ¶+æ•°æ®åº“è¿æ¥ï¼Œç”¨äºRBACé€»è¾‘çš„æœ¬åœ°æµ‹è¯•ã€‚