# RBAC 测试修复计划

## 一、问题分析

根据测试运行结果，发现以下关键问题：

1. **数据库模型与表结构不一致**：
   - `SysDept` 模型中定义了 `is_deleted` 字段，但实际数据库表中没有
   - `SysPosition` 模型中定义了 `is_deleted` 字段，但实际数据库表中没有
   - 导致 SQL 查询时出现 `Unknown column 'xxx.is_deleted' in 'field list'` 错误

2. **测试数据污染**：测试中创建的租户、用户等数据没有自动清理，可能影响后续测试

3. **测试之间相互依赖**：部分测试假设特定数据已存在

## 二、修复计划

### 1. 修复数据库模型

- **文件**：`app/models/rbac.py`
- **修复内容**：移除 `SysDept` 和 `SysPosition` 模型中的 `is_deleted` 字段
- **理由**：实际数据库表中没有这个字段，导致查询失败

### 2. 修复租户创建逻辑

- **文件**：`app/services/rbac_service.py`
- **修复内容**：确保 `create_tenant` 方法只传递数据库表中存在的字段
- **理由**：避免 `TypeError: 'company_name' is an invalid keyword argument for SysTenant` 错误

### 3. 优化测试用例

- **文件**：`tests/test_rbac_api.py`
- **优化内容**：
  - 确保测试数据唯一性，使用 UUID 生成唯一标识
  - 修复响应解析，使用正确的字段名（如 `tenant_id` 而非 `tenantId`）
  - 简化测试逻辑，避免不必要的依赖

### 4. 执行测试验证

- 运行修复后的测试用例
- 验证所有 RBAC 功能正常
- 确保冒烟测试通过

## 三、执行步骤

1. **修复数据库模型**：移除 `is_deleted` 字段
2. **修复服务层代码**：优化 `create_tenant` 方法
3. **运行测试**：验证修复效果
4. **执行冒烟测试**：确保核心功能正常

## 四、预期结果

- ✅ 所有测试用例通过
- ✅ 无数据库查询错误
- ✅ 核心 RBAC 功能正常
- ✅ 简单覆盖测试完成

## 五、后续建议

- 考虑使用数据库迁移工具（如 alembic）管理表结构变更
- 为测试创建专用数据库，避免污染开发环境
- 实现测试数据自动清理机制
- 逐步增加边界情况测试