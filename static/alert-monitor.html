<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËßÜÈ¢ëÁõëÊéßÊä•Ë≠¶Á≥ªÁªü</title>
    <style>
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
        }
        
        .header {
            background-color: #262f3e;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.5rem;
        }
        
        .status-bar {
            background-color: #f9f9f9;
            padding: 10px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .connected {
            color: #52c41a;
        }
        
        .disconnected {
            color: #f5222d;
        }
        
        .alert-count {
            background-color: #1890ff;
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 0.8rem;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-size: 0.9rem;
            font-weight: bold;
            color: #555;
        }
        
        .filter-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            min-width: 150px;
        }
        
        .filter-input:focus {
            outline: none;
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }
        
        .filter-button {
            background-color: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }
        
        .filter-button:hover {
            background-color: #096dd9;
        }
        
        .clear-filter {
            background-color: #f5f5f5;
            color: #666;
        }
        
        .clear-filter:hover {
            background-color: #e8e8e8;
        }
        
        .content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .alert-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .alert-item {
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            border-left: 4px solid #ff4d4f;
            transition: all 0.3s ease;
        }
        
        .alert-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        .alert-header {
            display: flex;
            justify-content: space-between;
            padding: 12px 15px;
            background-color: #fafafa;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .alert-type {
            font-weight: bold;
            color: #ff4d4f;
        }
        
        .alert-time {
            color: #888;
            font-size: 0.9rem;
        }
        
        .alert-body {
            padding: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .alert-info {
            flex: 1;
            min-width: 250px;
        }
        
        .alert-info p {
            margin: 5px 0;
            line-height: 1.5;
        }
        
        .alert-image {
            flex: 1;
            min-width: 250px;
            max-width: 500px;
        }
        
        .alert-image img {
            width: 100%;
            border-radius: 4px;
            object-fit: cover;
        }
        
        .alert-footer {
            padding: 10px 15px;
            border-top: 1px solid #f0f0f0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .alert-video-link {
            color: #1890ff;
            text-decoration: none;
            padding: 5px 10px;
        }
        
        .alert-video-link:hover {
            text-decoration: underline;
        }
        
        .alert-dismiss {
            background-color: #f0f0f0;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
        }
        
        .alert-dismiss:hover {
            background-color: #e0e0e0;
        }
        
        .no-alerts {
            text-align: center;
            padding: 50px;
            color: #999;
        }
        
        /* Êä•Ë≠¶Á±ªÂûãÊ†∑Âºè */
        .alert-type-no_helmet {
            border-left-color: #ff4d4f;
        }
        
        .alert-type-intrusion {
            border-left-color: #ff7a45;
        }
        
        .alert-type-fire {
            border-left-color: #ff4d4f;
        }
        
        .alert-type-smoke {
            border-left-color: #ffa940;
        }
        
        .alert-type-loitering {
            border-left-color: #faad14;
        }
        
        .alert-type-abnormal_behavior {
            border-left-color: #faad14;
        }
        
        .alert-type-test_alert {
            border-left-color: #1890ff;
        }
        
        .actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .test-button {
            background-color: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .test-button:hover {
            background-color: #096dd9;
        }
        
        .test-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .status-message {
            padding: 8px 12px;
            border-radius: 4px;
            margin-left: 10px;
            display: none;
        }
        
        .status-message.success {
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }
        
        .status-message.error {
            background-color: #fff1f0;
            border: 1px solid #ffa39e;
            color: #ff4d4f;
        }
        
        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
            margin-right: 5px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media screen and (max-width: 768px) {
            .status-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .filters {
                width: 100%;
                justify-content: space-between;
            }
        }
        
        /* üÜï Áä∂ÊÄÅÊ†áÁ≠æÊ†∑Âºè */
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            text-align: center;
            min-width: 60px;
        }
        
        .status-pending {
            background-color: #fff2e8;
            color: #d46b08;
            border: 1px solid #ffbb96;
        }
        
        .status-processing {
            background-color: #e6f7ff;
            color: #096dd9;
            border: 1px solid #91d5ff;
        }
        
        .status-resolved {
            background-color: #f6ffed;
            color: #389e0d;
            border: 1px solid #b7eb8f;
        }
        
        .status-archived {
            background-color: #f5f5f5;
            color: #8c8c8c;
            border: 1px solid #d9d9d9;
        }
        
        .status-false-alarm {
            background-color: #fff2f0;
            color: #cf1322;
            border: 1px solid #ffccc7;
        }
        
        /* üÜï Áä∂ÊÄÅÊìç‰ΩúÊåâÈíÆ */
        .status-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        
        .status-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .status-btn-process {
            background-color: #1890ff;
            color: white;
        }
        
        .status-btn-resolve {
            background-color: #52c41a;
            color: white;
        }
        
        /* üÜï Ê£ÄÊµãÁªìÊûúÊ†∑Âºè */
        .detection-results {
            margin-top: 15px;
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #1890ff;
        }
        
        .detection-results h4 {
            margin: 0 0 10px 0;
            color: #1890ff;
            font-size: 0.9rem;
        }
        
        .detection-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .detection-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background-color: white;
            border-radius: 4px;
            border: 1px solid #e8e8e8;
            flex-wrap: wrap;
        }
        
        .detection-name {
            font-weight: bold;
            color: #262626;
            min-width: 80px;
        }
        
        .detection-score {
            background-color: #52c41a;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8rem;
            font-weight: bold;
            min-width: 50px;
            text-align: center;
        }
        
        .detection-location {
            color: #666;
            font-size: 0.85rem;
            flex: 1;
            min-width: 200px;
        }
        
        /* üÜï ÁîµÂ≠êÂõ¥Ê†è‰ø°ÊÅØÊ†∑Âºè */
        .fence-info {
            margin-top: 10px;
            padding: 8px 12px;
            background-color: #fff7e6;
            border-radius: 4px;
            border-left: 3px solid #faad14;
        }
        
        .fence-info p {
            margin: 0;
            color: #d46b08;
            font-size: 0.9rem;
        }
        
        .status-btn-archive {
            background-color: #8c8c8c;
            color: white;
        }
        
        .status-btn-false-alarm {
            background-color: #f5222d;
            color: white;
        }
        
        .status-btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <!-- Êä•Ë≠¶Èü≥Êïà -->
    <audio id="alert-sound" src="/static/sound/alert.mp3" preload="auto"></audio>
    
    <!-- È°µÈù¢Â§¥ÈÉ® -->
    <header class="header">
        <h1>ËßÜÈ¢ëÁõëÊéßÊä•Ë≠¶Á≥ªÁªü</h1>
    </header>
    
    <!-- Áä∂ÊÄÅÊ†è -->
    <div class="status-bar">
        <div class="status-item">
            <span>SSEËøûÊé•:</span>
            <span id="connection-status" class="disconnected">Êú™ËøûÊé•</span>
        </div>
        
        <div class="status-item">
            <span>Êä•Ë≠¶Êï∞Èáè:</span>
            <span id="alert-count" class="alert-count">0</span>
        </div>
        
        <div class="status-item">
            <span>ËøûÊé•ID:</span>
            <span id="connection-id" class="alert-count">-</span>
        </div>
        
        <div class="filters">
            <select id="camera-filter">
                <option value="">ÊâÄÊúâÊëÑÂÉèÂ§¥</option>
                <option value="camera_01">ÊëÑÂÉèÂ§¥ 1</option>
                <option value="camera_02">ÊëÑÂÉèÂ§¥ 2</option>
                <option value="camera_03">ÊëÑÂÉèÂ§¥ 3</option>
            </select>
            
            <select id="alert-type-filter">
                <option value="">ÊâÄÊúâÊä•Ë≠¶Á±ªÂûã</option>
                <option value="no_helmet">Êú™‰Ω©Êà¥ÂÆâÂÖ®Â∏Ω</option>
                <option value="intrusion">ÂÖ•‰æµË≠¶Âëä</option>
                <option value="fire">ÁÅ´ÁÅæË≠¶Âëä</option>
                <option value="smoke">ÁÉüÈõæË≠¶Âëä</option>
                <option value="loitering">ÂæòÂæäË°å‰∏∫</option>
                <option value="abnormal_behavior">ÂºÇÂ∏∏Ë°å‰∏∫</option>
            </select>
        </div>
    </div>
    
    <!-- ‰∏ªÂÜÖÂÆπÂå∫Âüü -->
    <div class="content">
        <!-- üÜï ËøáÊª§Âô®Âå∫Âüü -->
        <div class="filters">
            <div class="filter-group">
                <label for="status-filter">Êä•Ë≠¶Áä∂ÊÄÅ</label>
                            <select id="status-filter" class="filter-input">
                <option value="">ÂÖ®ÈÉ®Áä∂ÊÄÅ</option>
                <option value="1">ÂæÖÂ§ÑÁêÜ</option>
                <option value="2">Â§ÑÁêÜ‰∏≠</option>
                <option value="3">Â∑≤Â§ÑÁêÜ</option>
                <option value="4">Â∑≤ÂΩíÊ°£</option>
                <option value="5">ËØØÊä•</option>
            </select>
            </div>
            
            <div class="filter-group">
                <label for="alert-type-filter">Êä•Ë≠¶Á±ªÂûã</label>
                <select id="alert-type-filter" class="filter-input">
                    <option value="">ÂÖ®ÈÉ®Á±ªÂûã</option>
                    <option value="no_helmet">Êú™‰Ω©Êà¥ÂÆâÂÖ®Â∏Ω</option>
                    <option value="intrusion">ÂÖ•‰æµË≠¶Âëä</option>
                    <option value="fire">ÁÅ´ÁÅæË≠¶Âëä</option>
                    <option value="smoke">ÁÉüÈõæË≠¶Âëä</option>
                    <option value="loitering">ÂæòÂæäË°å‰∏∫</option>
                    <option value="abnormal_behavior">ÂºÇÂ∏∏Ë°å‰∏∫</option>
                    <option value="test_alert">ÊµãËØïÊä•Ë≠¶</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="camera-filter">ÊëÑÂÉèÂ§¥</label>
                <input type="text" id="camera-filter" class="filter-input" placeholder="ÊëÑÂÉèÂ§¥ÂêçÁß∞ÊàñID">
            </div>
            
            <div class="filter-group">
                <label for="start-date">ÂºÄÂßãÊó•Êúü</label>
                <input type="date" id="start-date" class="filter-input">
            </div>
            
            <div class="filter-group">
                <label for="end-date">ÁªìÊùüÊó•Êúü</label>
                <input type="date" id="end-date" class="filter-input">
            </div>
            
            <div class="filter-group">
                <label>&nbsp;</label>
                <div style="display: flex; gap: 10px;">
                    <button class="filter-button" onclick="applyFilters()">üîç Á≠õÈÄâ</button>
                    <button class="filter-button clear-filter" onclick="clearFilters()">üîÑ Ê∏ÖÁ©∫</button>
                </div>
            </div>
        </div>
        
        <div class="actions">
            <div>
                <button id="send-test-alert" class="test-button">üéØ ÁîüÊàêÊµãËØïÊä•Ë≠¶</button>
                <span id="status-message" class="status-message"></span>
            </div>
            <div>
                <button id="refresh-alerts" class="test-button" style="background-color: #52c41a;">üîÑ Âà∑Êñ∞Êä•Ë≠¶</button>
                <button id="check-sse-status" class="test-button" style="background-color: #1890ff;">üìä ËøûÊé•Áä∂ÊÄÅ</button>
                <button id="show-statistics" class="test-button" style="background-color: #722ed1;">üìà ÁªüËÆ°‰ø°ÊÅØ</button>
            </div>
        </div>
        
        <div id="alert-container" class="alert-container">
            <div class="no-alerts">
                <p>Á≠âÂæÖÊä•Ë≠¶Êï∞ÊçÆ...</p>
            </div>
        </div>
    </div>
    
    <script>
        // Êä•Ë≠¶Á±ªÂûãÂíåÂØπÂ∫îÁöÑÊòæÁ§∫ÊñáÊú¨
        const ALERT_TYPES = {
          'no_helmet': 'Êú™‰Ω©Êà¥ÂÆâÂÖ®Â∏Ω',
          'intrusion': 'ÂÖ•‰æµË≠¶Âëä',
          'fire': 'ÁÅ´ÁÅæË≠¶Âëä',
          'smoke': 'ÁÉüÈõæË≠¶Âëä',
          'loitering': 'ÂæòÂæäË°å‰∏∫',
          'abnormal_behavior': 'ÂºÇÂ∏∏Ë°å‰∏∫',
          'test_alert': 'ÊµãËØïÊä•Ë≠¶'
        };

        // Áä∂ÊÄÅÊò†Â∞ÑÂíåÊ†∑Âºè - Âè™ÊîØÊåÅÊï¥Êï∞Á±ªÂûã
        const ALERT_STATUSES = {
          1: { class: 'status-pending', icon: '‚è≥', display: 'ÂæÖÂ§ÑÁêÜ' },
          2: { class: 'status-processing', icon: 'üîÑ', display: 'Â§ÑÁêÜ‰∏≠' },
          3: { class: 'status-resolved', icon: '‚úÖ', display: 'Â∑≤Â§ÑÁêÜ' },
          4: { class: 'status-archived', icon: 'üìÇ', display: 'Â∑≤ÂΩíÊ°£' },
          5: { class: 'status-false-alarm', icon: '‚ùå', display: 'ËØØÊä•' }
        };

        // Ëé∑ÂèñÁä∂ÊÄÅ‰ø°ÊÅØÁöÑËæÖÂä©ÂáΩÊï∞
        function getStatusInfo(status) {
          return ALERT_STATUSES[status] || ALERT_STATUSES[1];
        }

        // ÂÖ®Â±ÄÂèòÈáè
        let eventSource = null;
        let alertCount = 0;
        let reconnectTimeout = null;
        let connectionId = null;
        let isConnecting = false;
        const MAX_ALERTS = 100; // ÊúÄÂ§öÊòæÁ§∫ÁöÑÊä•Ë≠¶Êï∞Èáè
        
        // Ê∑ªÂä†ËøûÊé•ÁªüËÆ°
        let connectionStats = {
          totalConnections: 0,
          totalReconnects: 0,
          lastConnectTime: null,
          lastDisconnectTime: null,
          connectionHistory: []
        };

        // DOMÂÖÉÁ¥†
        let alertContainer;
        let connectionStatus;
        let alertCountElement;
        let connectionIdElement;
        let cameraFilter;
        let alertTypeFilter;
        let statusMessage;
        // üÜï Êñ∞Â¢ûËøáÊª§Âô®ÂÖÉÁ¥†
        let statusFilter;
        let startDateFilter;
        let endDateFilter;
        let cameraNameFilter;

        // ÁîüÊàêÂîØ‰∏ÄËøûÊé•ID
        function generateConnectionId() {
            return 'conn_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // ÂàùÂßãÂåñÂáΩÊï∞
        function initAlertMonitor() {
          console.log('ÂàùÂßãÂåñÊä•Ë≠¶ÁõëÊéßÁ≥ªÁªü...');
          
          // ÁîüÊàêËøûÊé•ID
          connectionId = generateConnectionId();
          
          // Ëé∑ÂèñDOMÂÖÉÁ¥†
          alertContainer = document.getElementById('alert-container');
          connectionStatus = document.getElementById('connection-status');
          alertCountElement = document.getElementById('alert-count');
          connectionIdElement = document.getElementById('connection-id');
          cameraFilter = document.getElementById('camera-filter');
          alertTypeFilter = document.getElementById('alert-type-filter');
          statusMessage = document.getElementById('status-message');
          
          // ÊòæÁ§∫ËøûÊé•ID
          if (connectionIdElement) {
            connectionIdElement.textContent = connectionId.substr(-8);
          }
          
          // ÂàùÂßãÂåñËøáÊª§Âô®‰∫ã‰ª∂
          if (cameraFilter) {
            cameraFilter.addEventListener('change', filterAlerts);
          }
          
          if (alertTypeFilter) {
            alertTypeFilter.addEventListener('change', filterAlerts);
          }
          
          // ËøûÊé•Âà∞SSE
          connectSSE();
          
          // Âä†ËΩΩÂéÜÂè≤Êä•Ë≠¶Êï∞ÊçÆ
          loadHistoricalAlerts();
          
          // Ê∑ªÂä†ÊµãËØïÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
          const testButton = document.getElementById('send-test-alert');
          if (testButton) {
            testButton.addEventListener('click', sendTestAlert);
          }
          
          // Ê∑ªÂä†Âà∑Êñ∞ÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
          const refreshButton = document.getElementById('refresh-alerts');
          if (refreshButton) {
            refreshButton.addEventListener('click', loadHistoricalAlerts);
          }
          
          // Ê∑ªÂä†ËøûÊé•Áä∂ÊÄÅÊ£ÄÊü•ÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
          const checkStatusButton = document.getElementById('check-sse-status');
          if (checkStatusButton) {
            checkStatusButton.addEventListener('click', checkSSEStatus);
          }
          
          // È°µÈù¢Âç∏ËΩΩÊó∂Ê∏ÖÁêÜËøûÊé•
          window.addEventListener('beforeunload', function() {
            cleanupConnection();
          });
          
          // È°µÈù¢ÂèØËßÅÊÄßÂèòÂåñÊó∂ÁÆ°ÁêÜËøûÊé•
          document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
              console.log('È°µÈù¢ÈöêËóèÔºåÊöÇÂÅúÈáçËøû');
              // üîß ‰ºòÂåñÔºöÈ°µÈù¢ÈöêËóèÊó∂ÂèñÊ∂àÈáçËøûËÆ°Êó∂Âô®Ôºå‰ΩÜ‰∏çÂÖ≥Èó≠ËøûÊé•
              if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
                reconnectTimeout = null;
                console.log('Â∑≤ÂèñÊ∂àÈáçËøûËÆ°Êó∂Âô®');
              }
            } else {
              console.log('È°µÈù¢ÊòæÁ§∫ÔºåÊ£ÄÊü•ËøûÊé•Áä∂ÊÄÅ');
              // üîß ‰ºòÂåñÔºöÊõ¥‰∏•Ê†ºÁöÑËøûÊé•Áä∂ÊÄÅÊ£ÄÊü•
              if (!eventSource) {
                console.log('üîÑ eventSource‰∏çÂ≠òÂú®ÔºåÂª∫Á´ãÊñ∞ËøûÊé•');
                connectSSE();
              } else if (eventSource.readyState === EventSource.CLOSED) {
                console.log('üîÑ ËøûÊé•Â∑≤ÂÖ≥Èó≠ÔºåÂª∫Á´ãÊñ∞ËøûÊé•');
                connectSSE();
              } else if (eventSource.readyState === EventSource.CONNECTING) {
                console.log('‚è≥ ËøûÊé•Ê≠£Âú®Âª∫Á´ã‰∏≠ÔºåÁ≠âÂæÖ...');
              } else if (eventSource.readyState === EventSource.OPEN) {
                console.log('‚úÖ ËøûÊé•Ê≠£Â∏∏ÔºåÊó†ÈúÄÈáçÊñ∞ËøûÊé•');
              }
            }
          });
        }

        // Ê∏ÖÁêÜËøûÊé•
        function cleanupConnection() {
          console.log('Ê∏ÖÁêÜSSEËøûÊé•:', connectionId);
          
          if (reconnectTimeout) {
            clearTimeout(reconnectTimeout);
            reconnectTimeout = null;
          }
          
          if (eventSource) {
            eventSource.close();
            eventSource = null;
          }
          
          isConnecting = false;
        }

        // ËøûÊé•Âà∞SSEÊúçÂä°Âô®
        function connectSSE() {
          // üîß ‰ºòÂåñÔºöÊõ¥‰∏•Ê†ºÁöÑÈáçÂ§çËøûÊé•Ê£ÄÊü•
          if (isConnecting) {
            console.log('‚ö†Ô∏è Ê≠£Âú®ËøûÊé•‰∏≠ÔºåË∑≥ËøáÈáçÂ§çËøûÊé•ËØ∑Ê±Ç');
            return;
          }
          
          // üîß ‰ºòÂåñÔºöÊ£ÄÊü•Áé∞ÊúâËøûÊé•Áä∂ÊÄÅÔºåÂåÖÊã¨CONNECTINGÁä∂ÊÄÅ
          if (eventSource) {
            if (eventSource.readyState === EventSource.OPEN) {
              console.log('‚úÖ SSEËøûÊé•Â∑≤Â≠òÂú®‰∏îÊ≠£Â∏∏ÔºåÊó†ÈúÄÈáçÊñ∞ËøûÊé•');
              return;
            } else if (eventSource.readyState === EventSource.CONNECTING) {
              console.log('‚è≥ SSEËøûÊé•Ê≠£Âú®Âª∫Á´ã‰∏≠ÔºåÁ≠âÂæÖÂÆåÊàê...');
              return;
            }
          }
          
          // Ê∏ÖÁêÜÊóßËøûÊé•
          cleanupConnection();
          
          isConnecting = true;
          console.log('üîó ÂºÄÂßãÂª∫Á´ãSSEËøûÊé•:', connectionId);
          console.log('üîç Ë∞ÉÁî®Ê†à:', new Error().stack);  // Ê∑ªÂä†Ë∞ÉÁî®Ê†àË∑üË∏™
          
          // ËÆ∞ÂΩïËøûÊé•ÁªüËÆ°
          connectionStats.totalConnections++;
          connectionStats.lastConnectTime = new Date();
          connectionStats.connectionHistory.push({
            type: 'connect_attempt',
            time: new Date(),
            connectionId: connectionId
          });
          
          // ‰øùÊåÅÂéÜÂè≤ËÆ∞ÂΩïÂú®ÂêàÁêÜËåÉÂõ¥ÂÜÖ
          if (connectionStats.connectionHistory.length > 50) {
            connectionStats.connectionHistory = connectionStats.connectionHistory.slice(-50);
          }
          
          console.log('üìä ËøûÊé•ÁªüËÆ°:', connectionStats);
          
          // Êõ¥Êñ∞Áä∂ÊÄÅ
          updateConnectionStatus('Ê≠£Âú®ËøûÊé•...');
          
          // ÂàõÂª∫Êñ∞ËøûÊé•
          eventSource = new EventSource('/api/v1/alerts/stream');
          
          // ËøûÊé•ÊâìÂºÄ‰∫ã‰ª∂
          eventSource.addEventListener('open', function() {
            console.log('‚úÖ SSEËøûÊé•Â∑≤Âª∫Á´ã:', connectionId);
            updateConnectionStatus('Â∑≤ËøûÊé•');
            isConnecting = false;
            
            // ÂèñÊ∂àÈáçËøûËÆ°Êó∂Âô®
            if (reconnectTimeout) {
              clearTimeout(reconnectTimeout);
              reconnectTimeout = null;
            }
          });
          
          // Ê∂àÊÅØ‰∫ã‰ª∂
          eventSource.addEventListener('message', function(event) {
            try {
              const data = JSON.parse(event.data);
              
              // Â¶ÇÊûúÊòØËøûÊé•ÊàêÂäüÊ∂àÊÅØÔºåÂøΩÁï•
              if (data.event === 'connected') {
                console.log('üì° Êî∂Âà∞SSEËøûÊé•Á°ÆËÆ§Ê∂àÊÅØ');
                return;
              }
              
              // Â§ÑÁêÜÊä•Ë≠¶Ê∂àÊÅØ
              console.log('üö® Êî∂Âà∞SSEÊä•Ë≠¶Ê∂àÊÅØ:', data);
              handleAlertMessage(data);
              
            } catch (error) {
              console.error('‚ùå Ëß£ÊûêÊä•Ë≠¶Ê∂àÊÅØÂ§±Ë¥•:', error, event.data);
            }
          });
          
          // ÈîôËØØ‰∫ã‰ª∂
          eventSource.addEventListener('error', function(event) {
            console.log('‚ùå SSEËøûÊé•ÈîôËØØ:', event);
            console.log('üîç ÈîôËØØÊó∂ËøûÊé•Áä∂ÊÄÅ:', eventSource ? eventSource.readyState : 'null');
            console.log('üîç È°µÈù¢ÂèØËßÅÊÄß:', document.hidden ? 'ÈöêËóè' : 'ÂèØËßÅ');
            
            // ËÆ∞ÂΩïÊñ≠ÂºÄÁªüËÆ°
            connectionStats.lastDisconnectTime = new Date();
            connectionStats.connectionHistory.push({
              type: 'disconnect',
              time: new Date(),
              connectionId: connectionId,
              readyState: eventSource ? eventSource.readyState : null
            });
            
            updateConnectionStatus('ËøûÊé•Êñ≠ÂºÄ');
            isConnecting = false;
            
            // üîß ‰ºòÂåñÔºöÊõ¥Á≤æÁ°ÆÁöÑÈáçËøûÊù°‰ª∂Âà§Êñ≠
            if (eventSource && eventSource.readyState === EventSource.CLOSED) {
              // Âè™ÊúâÂú®È°µÈù¢ÂèØËßÅ„ÄÅÊó†ÈáçËøûËÆ°Êó∂Âô®‰∏îËøûÊé•ÁúüÊ≠£ÂÖ≥Èó≠Êó∂ÊâçÈáçËøû
              if (!document.hidden && !reconnectTimeout) {
                console.log('‚è≥ 10ÁßíÂêéÂ∞ùËØïÈáçËøû...');
                connectionStats.totalReconnects++;
                reconnectTimeout = setTimeout(() => {
                  console.log('üîÑ ÊâßË°åÈáçËøû...');
                  reconnectTimeout = null;
                  // üîß ‰ºòÂåñÔºöÈáçËøûÂâçÂÜçÊ¨°Ê£ÄÊü•ËøûÊé•Áä∂ÊÄÅ
                  if (!eventSource || eventSource.readyState === EventSource.CLOSED) {
                    connectSSE();
                  } else {
                    console.log('üö´ ËøûÊé•Áä∂ÊÄÅÂ∑≤ÊÅ¢Â§çÔºåÂèñÊ∂àÈáçËøû');
                  }
                }, 10000); // Â¢ûÂä†ÈáçËøûÈó¥ÈöîÂà∞10Áßí
              } else {
                console.log('üö´ Ë∑≥ËøáÈáçËøû - È°µÈù¢ÈöêËóè:', document.hidden, 'ÊàñÂ∑≤ÊúâÈáçËøûËÆ°Êó∂Âô®:', !!reconnectTimeout);
              }
            } else {
              console.log('üîç ËøûÊé•Áä∂ÊÄÅÈùûCLOSEDÔºåÁ≠âÂæÖÁä∂ÊÄÅÂèòÂåñ...');
            }
          });
        }

        // Êõ¥Êñ∞ËøûÊé•Áä∂ÊÄÅÊòæÁ§∫
        function updateConnectionStatus(status) {
          if (connectionStatus) {
            connectionStatus.textContent = status;
            connectionStatus.className = status === 'Â∑≤ËøûÊé•' ? 'connected' : 'disconnected';
          }
        }

        // Â§ÑÁêÜÊä•Ë≠¶Ê∂àÊÅØ
        function handleAlertMessage(alert) {
          console.log('Â§ÑÁêÜÊä•Ë≠¶Ê∂àÊÅØ:', alert);
          
          // üÜï Ë∞ÉËØïÊñ∞Â≠óÊÆµÊ†ºÂºè
          if (alert.electronic_fence) {
            console.log('üöß Êî∂Âà∞ÁîµÂ≠êÂõ¥Ê†èÊï∞ÊçÆ:', alert.electronic_fence);
          }
          if (alert.result && Array.isArray(alert.result)) {
            console.log('üéØ Êî∂Âà∞Ê£ÄÊµãÁªìÊûúÊï∞ÊçÆ:', alert.result.length + '‰∏™ÂØπË±°');
          }
          
          // ÂàõÂª∫Êä•Ë≠¶ÂÖÉÁ¥†
          const alertElement = createAlertElement(alert);
          
          // Ê∏ÖÈô§"Á≠âÂæÖÊä•Ë≠¶Êï∞ÊçÆ"ÊèêÁ§∫
          const noAlertsElement = alertContainer.querySelector('.no-alerts');
          if (noAlertsElement) {
            noAlertsElement.remove();
          }
          
          // Ê∑ªÂä†Âà∞ÂÆπÂô®È°∂ÈÉ®
          if (alertContainer) {
            alertContainer.insertBefore(alertElement, alertContainer.firstChild);
            
            // Â¶ÇÊûúÊä•Ë≠¶Â§™Â§öÔºåÁßªÈô§ÊóßÁöÑ
            while (alertContainer.children.length > MAX_ALERTS) {
              alertContainer.removeChild(alertContainer.lastChild);
            }
          }
          
          // üîß ‰øÆÂ§çÔºöÂü∫‰∫éÂÆûÈôÖÊòæÁ§∫ÁöÑÊä•Ë≠¶ÂÖÉÁ¥†Êï∞ÈáèÊõ¥Êñ∞ËÆ°Êï∞
          const currentAlertElements = alertContainer.querySelectorAll('.alert-item');
          alertCount = currentAlertElements.length;
          if (alertCountElement) {
            alertCountElement.textContent = alertCount;
          }
          
          console.log(`üìä ÂÆûÊó∂Êä•Ë≠¶Â∑≤Ê∑ªÂä†ÔºåÂΩìÂâçÊòæÁ§∫ ${alertCount} Êù°Êä•Ë≠¶`);
          
          // Êí≠ÊîæÂ£∞Èü≥ÊèêÁ§∫
          playAlertSound();
        }

        // ÂàõÂª∫Êä•Ë≠¶ÂÖÉÁ¥†
        function createAlertElement(alert) {
          const alertDiv = document.createElement('div');
          alertDiv.className = 'alert-item';
          alertDiv.dataset.alertId = alert.alert_id;
          alertDiv.dataset.cameraId = alert.camera_id;
          alertDiv.dataset.alertType = alert.alert_type;
          alertDiv.dataset.alertStatus = alert.status || 'ÂæÖÂ§ÑÁêÜ';
          
          // ËÆæÁΩÆÊä•Ë≠¶Á±ªÂûãÊ†∑Âºè
          alertDiv.classList.add(`alert-type-${alert.alert_type}`);
          
          // Ê†ºÂºèÂåñÊó∂Èó¥
          const alertTime = new Date(alert.alert_time);
          const formattedTime = alertTime.toLocaleString('zh-CN');
          
          // Ëé∑ÂèñÊä•Ë≠¶Á±ªÂûãÊòæÁ§∫ÊñáÊú¨
          const alertTypeText = ALERT_TYPES[alert.alert_type] || alert.alert_type;
          
          // Ëé∑ÂèñÁä∂ÊÄÅ‰ø°ÊÅØ
          const status = alert.status || 1;
          const statusDisplay = alert.status_display || getStatusInfo(alert.status).display;
          const statusInfo = getStatusInfo(alert.status);
          
          // üÜï Ê†ºÂºèÂåñÂ§ÑÁêÜÊó∂Èó¥
          let processedTimeHtml = '';
          if (alert.processed_at) {
            const processedTime = new Date(alert.processed_at);
            processedTimeHtml = `<p><strong>Â§ÑÁêÜÊó∂Èó¥:</strong> ${processedTime.toLocaleString('zh-CN')}</p>`;
          }
          
          // üÜï Â§ÑÁêÜ‰∫∫Âëò‰ø°ÊÅØ
          let processedByHtml = '';
          if (alert.processed_by) {
            processedByHtml = `<p><strong>Â§ÑÁêÜ‰∫∫Âëò:</strong> ${alert.processed_by}</p>`;
          }
          
          // üÜï Â§ÑÁêÜÂ§áÊ≥®
          let processingNotesHtml = '';
          if (alert.processing_notes) {
            processingNotesHtml = `<p><strong>Â§ÑÁêÜÂ§áÊ≥®:</strong> ${alert.processing_notes}</p>`;
          }
          
          // Áä∂ÊÄÅÊìç‰ΩúÊåâÈíÆ
          let statusActionsHtml = '';
          const statusValue = alert.status;
          
          if (statusValue === 1) {
            statusActionsHtml = `
              <div class="status-actions">
                <button class="status-btn status-btn-process" onclick="updateAlertStatus(${alert.alert_id}, 2)">
                  üîÑ ÂºÄÂßãÂ§ÑÁêÜ
                </button>
                                  <button class="status-btn status-btn-resolve" onclick="updateAlertStatus(${alert.alert_id}, 3)">
                    ‚úÖ Ê†áËÆ∞Â∑≤Â§ÑÁêÜ
                  </button>
                  <button class="status-btn status-btn-archive" onclick="updateAlertStatus(${alert.alert_id}, 4)">
                    üìÇ ÂΩíÊ°£
                  </button>
                  <button class="status-btn status-btn-false-alarm" onclick="updateAlertStatus(${alert.alert_id}, 5)">
                    ‚ùå ËØØÊä•
                  </button>
              </div>
            `;
          } else if (statusValue === 2) {
            statusActionsHtml = `
              <div class="status-actions">
                <button class="status-btn status-btn-resolve" onclick="updateAlertStatus(${alert.alert_id}, 3)">
                  ‚úÖ ÂÆåÊàêÂ§ÑÁêÜ
                </button>
                <button class="status-btn status-btn-archive" onclick="updateAlertStatus(${alert.alert_id}, 4)">
                  üìÇ ÂΩíÊ°£
                </button>
                <button class="status-btn status-btn-false-alarm" onclick="updateAlertStatus(${alert.alert_id}, 5)">
                  ‚ùå ËØØÊä•
                </button>
              </div>
            `;
          }
          
          // üÜï Â§ÑÁêÜÊ£ÄÊµãÁªìÊûúÊï∞ÊçÆ
          let detectionsHtml = '';
          if (alert.result && Array.isArray(alert.result) && alert.result.length > 0) {
            detectionsHtml = `
              <div class="detection-results">
                <h4>üéØ Ê£ÄÊµãÁªìÊûú (${alert.result.length}‰∏™ÂØπË±°)</h4>
                <div class="detection-list">
                  ${alert.result.map(detection => `
                    <div class="detection-item">
                      <span class="detection-name">${detection.name}</span>
                      <span class="detection-score">${(detection.score * 100).toFixed(1)}%</span>
                      <span class="detection-location">‰ΩçÁΩÆ: (${detection.location?.left || 0}, ${detection.location?.top || 0}) Â∞∫ÂØ∏: ${detection.location?.width || 0}√ó${detection.location?.height || 0}</span>
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
          }

          // üÜï Â§ÑÁêÜÁîµÂ≠êÂõ¥Ê†èÊï∞ÊçÆ
          let fenceHtml = '';
          if (alert.electronic_fence && typeof alert.electronic_fence === 'object') {
            const fence = alert.electronic_fence;
            const enabled = fence.enabled ? 'ÂêØÁî®' : 'Á¶ÅÁî®';
            const triggerMode = fence.trigger_mode === 'inside' ? 'Âå∫ÂüüÂÜÖËß¶Âèë' : 
                               fence.trigger_mode === 'outside' ? 'Âå∫ÂüüÂ§ñËß¶Âèë' : 
                               fence.trigger_mode || 'Êú™Áü•';
            const pointsCount = fence.points ? fence.points.length : 0;
            
            fenceHtml = `
              <div class="fence-info">
                <p><strong>üöß ÁîµÂ≠êÂõ¥Ê†è:</strong> ${enabled} | ${triggerMode} | ${pointsCount}‰∏™Âå∫Âüü</p>
              </div>
            `;
          }

          // ÊûÑÂª∫HTMLÂÜÖÂÆπ
          alertDiv.innerHTML = `
            <div class="alert-header">
              <span class="alert-type">${alertTypeText}</span>
              <div style="display: flex; align-items: center; gap: 10px;">
                <span class="status-badge ${statusInfo.class}">
                  ${statusInfo.icon} ${statusDisplay}
                </span>
                <span class="alert-time">${formattedTime}</span>
              </div>
            </div>
            <div class="alert-body">
              <div class="alert-info">
                <p><strong>ID:</strong> ${alert.alert_id || 'Êú™Áü•'}</p>
                <p><strong>Êä•Ë≠¶ÂêçÁß∞:</strong> ${alert.alert_name || 'Êú™Áü•'}</p>
                <p><strong>Êä•Ë≠¶ÊèèËø∞:</strong> ${alert.alert_description || 'Êó†ÊèèËø∞'}</p>
                <p><strong>ÊëÑÂÉèÂ§¥:</strong> ${alert.camera_name || alert.camera_id}</p>
                <p><strong>‰ΩçÁΩÆ:</strong> ${alert.location || 'Êú™Áü•'}</p>
                <p><strong>Êä•Ë≠¶Á≠âÁ∫ß:</strong> ${alert.alert_level || 1}</p>
                <p><strong>‰ªªÂä°ID:</strong> ${alert.task_id || 'Êú™Áü•'}</p>
                <p><strong>ÊäÄËÉΩID:</strong> ${alert.skill_class_id || 'Êú™Áü•'}</p>
                <p><strong>ÊäÄËÉΩÂêçÁß∞:</strong> ${alert.skill_name_zh || 'Êú™Áü•'}</p>
                ${fenceHtml}
                ${detectionsHtml}
                ${processedTimeHtml}
                ${processedByHtml}
                ${processingNotesHtml}
              </div>
              <div class="alert-image">
                <img src="${alert.minio_frame_url || '/static/img/no-image.png'}" alt="Êä•Ë≠¶Êà™Âõæ" onerror="this.src='/static/img/no-image.png'">
              </div>
            </div>
            <div class="alert-footer">
              <a href="${alert.minio_video_url || '#'}" target="_blank" class="alert-video-link">Êü•ÁúãËßÜÈ¢ë</a>
              ${statusActionsHtml}
              <button class="alert-dismiss" onclick="dismissAlert(this.parentNode.parentNode)">ÂøΩÁï•ÊòæÁ§∫</button>
            </div>
          `;
          
          return alertDiv;
        }

        // Êí≠ÊîæÊä•Ë≠¶Â£∞Èü≥
        function playAlertSound() {
          const audio = document.getElementById('alert-sound');
          if (audio) {
            audio.play().catch(error => {
              // ÂøΩÁï•Áî®Êà∑‰∫§‰∫íÈôêÂà∂ÂØºËá¥ÁöÑÈîôËØØ
              console.log('Êó†Ê≥ïÊí≠ÊîæÂ£∞Èü≥:', error);
            });
          }
        }

        // ÂøΩÁï•Êä•Ë≠¶
        function dismissAlert(alertElement) {
          if (alertElement && alertElement.parentNode) {
            alertElement.parentNode.removeChild(alertElement);
            
            // üîß ‰øÆÂ§çÔºöÁßªÈô§Êä•Ë≠¶ÂêéÊõ¥Êñ∞ËÆ°Êï∞
            const currentAlertElements = alertContainer.querySelectorAll('.alert-item');
            alertCount = currentAlertElements.length;
            if (alertCountElement) {
              alertCountElement.textContent = alertCount;
            }
            
            console.log(`üìä Êä•Ë≠¶Â∑≤ÂøΩÁï•ÔºåÂΩìÂâçÊòæÁ§∫ ${alertCount} Êù°Êä•Ë≠¶`);
            
            // Â¶ÇÊûúÊ≤°ÊúâÊä•Ë≠¶‰∫ÜÔºåÊòæÁ§∫ÊèêÁ§∫
            if (alertCount === 0) {
              alertContainer.innerHTML = '<div class="no-alerts"><p>ÊöÇÊó†Êä•Ë≠¶Êï∞ÊçÆ</p></div>';
            }
          }
        }

        // ËøáÊª§Êä•Ë≠¶
        function filterAlerts() {
          const cameraId = cameraFilter ? cameraFilter.value : '';
          const alertType = alertTypeFilter ? alertTypeFilter.value : '';
          
          // ÈÅçÂéÜÊâÄÊúâÊä•Ë≠¶ÂÖÉÁ¥†
          const alerts = alertContainer.getElementsByClassName('alert-item');
          for (let i = 0; i < alerts.length; i++) {
            const alert = alerts[i];
            let visible = true;
            
            // ÊåâÊëÑÂÉèÂ§¥ËøáÊª§
            if (cameraId && alert.dataset.cameraId !== cameraId) {
              visible = false;
            }
            
            // ÊåâÊä•Ë≠¶Á±ªÂûãËøáÊª§
            if (alertType && alert.dataset.alertType !== alertType) {
              visible = false;
            }
            
            // ËÆæÁΩÆÂèØËßÅÊÄß
            alert.style.display = visible ? 'block' : 'none';
          }
        }

        // Âä†ËΩΩÂéÜÂè≤Êä•Ë≠¶Êï∞ÊçÆ
        async function loadHistoricalAlerts() {
          try {
            showStatusMessage('Ê≠£Âú®Âä†ËΩΩÂéÜÂè≤Êä•Ë≠¶...', 'info');
            
            const response = await fetch('/api/v1/alerts/real-time?limit=20');
            if (!response.ok) {
              throw new Error('Ëé∑ÂèñÂéÜÂè≤Êä•Ë≠¶Â§±Ë¥•');
            }
            
            const data = await response.json();
            const alerts = data.alerts || [];
            
            console.log('üìä Âä†ËΩΩÊä•Ë≠¶Êï∞ÊçÆ:', {
              loaded_alerts: alerts.length,
              total_in_db: data.total,
              pages: data.pages,
              current_page: data.page
            });
            
            // Ê∏ÖÁ©∫ÂÆπÂô®
            if (alertContainer) {
              alertContainer.innerHTML = '';
            }
            
            if (alerts.length === 0) {
              alertContainer.innerHTML = '<div class="no-alerts"><p>ÊöÇÊó†Êä•Ë≠¶Êï∞ÊçÆ</p></div>';
              // üîß ‰øÆÂ§çÔºöÊ≤°ÊúâÊï∞ÊçÆÊó∂ÔºåÊòæÁ§∫ËÆ∞ÂΩïÊï∞‰∏∫0
              alertCount = 0;
              if (alertCountElement) {
                alertCountElement.textContent = 0;
              }
              showStatusMessage('ÊöÇÊó†Êä•Ë≠¶Êï∞ÊçÆ', 'info');
            } else {
              // Ê∑ªÂä†Êä•Ë≠¶
              alerts.forEach(alert => {
                const alertElement = createAlertElement(alert);
                alertContainer.appendChild(alertElement);
              });
              
              // üîß ‰øÆÂ§çÔºöÊòæÁ§∫ÂΩìÂâçÈ°µÈù¢Âä†ËΩΩÁöÑËÆ∞ÂΩïÊï∞ÔºåËÄå‰∏çÊòØÊï∞ÊçÆÂ∫ìÊÄªÊï∞
              alertCount = alerts.length;
              if (alertCountElement) {
                alertCountElement.textContent = alerts.length;
              }
              
              // üîß ‰øÆÂ§çÔºöÁä∂ÊÄÅÊ∂àÊÅØÊòæÁ§∫Êõ¥ËØ¶ÁªÜÁöÑ‰ø°ÊÅØ
              const totalRecords = data.total || alerts.length;
              const statusMsg = totalRecords > alerts.length 
                ? `Âä†ËΩΩÂÆåÊàêÔºåÊòæÁ§∫ÊúÄÊñ∞ ${alerts.length} Êù°ËÆ∞ÂΩïÔºàÊï∞ÊçÆÂ∫ìÂÖ± ${totalRecords} Êù°Ôºâ`
                : `Âä†ËΩΩÂÆåÊàêÔºåÂÖ± ${alerts.length} Êù°ËÆ∞ÂΩï`;
              
              showStatusMessage(statusMsg, 'success');
              
              console.log(`‚úÖ Êä•Ë≠¶Êï∞ÊçÆÂä†ËΩΩÂÆåÊàê: ÊòæÁ§∫${alerts.length}Êù°ÔºåÊÄªËÆ°${totalRecords}Êù°`);
            }
            
          } catch (error) {
            console.error('Âä†ËΩΩÂéÜÂè≤Êä•Ë≠¶Â§±Ë¥•:', error);
            showStatusMessage('Âä†ËΩΩÂ§±Ë¥•: ' + error.message, 'error');
            
            // üîß ‰øÆÂ§çÔºöÂá∫ÈîôÊó∂ÈáçÁΩÆËÆ°Êï∞Âô®
            alertCount = 0;
            if (alertCountElement) {
              alertCountElement.textContent = 0;
            }
          }
        }

        // ÁîüÊàêÊµãËØïÊä•Ë≠¶Ôºà‰ΩøÁî®AI‰ªªÂä°ÊâßË°åÂô®Ôºâ
        async function sendTestAlert() {
          const button = document.getElementById('send-test-alert');
          const originalText = button.innerHTML;
          
          try {
            // Á¶ÅÁî®ÊåâÈíÆÂπ∂ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            button.disabled = true;
            button.innerHTML = '<span class="loading"></span>ÁîüÊàê‰∏≠...';
            
            showStatusMessage('Ê≠£Âú®‰ΩøÁî®AI‰ªªÂä°ÊâßË°åÂô®ÁîüÊàêÊµãËØïÊä•Ë≠¶...', 'info');
            console.log('ÁîüÊàêÊµãËØïÊä•Ë≠¶ËØ∑Ê±Ç, ËøûÊé•ID:', connectionId);
            
            const response = await fetch('/api/v1/alerts/test', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              }
            });
            
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            console.log('ÊµãËØïÊä•Ë≠¶ÁîüÊàêÊàêÂäü:', result);
            
            // Ê†πÊçÆÊñ∞Êé•Âè£ÁöÑÂìçÂ∫îÊ†ºÂºèÊèê‰æõÊõ¥ËØ¶ÁªÜÁöÑÂèçÈ¶à
            const alertId = result.alert_id || 'unknown';
            const method = result.method || 'unknown';
            const isAIExecutor = method.includes('ai_task_executor');
            
            if (isAIExecutor) {
              showStatusMessage(`‚úÖ ÊµãËØïÊä•Ë≠¶ÁîüÊàêÊàêÂäüÔºÅ‰ΩøÁî®AI‰ªªÂä°ÊâßË°åÂô® (ID: ${alertId})`, 'success');
              console.log(`üéØ Ë∞ÉÁî®ÊñπÊ≥ï: ${method}`);
            } else {
              showStatusMessage(`‚úÖ ÊµãËØïÊä•Ë≠¶ÂèëÈÄÅÊàêÂäüÔºÅ(ID: ${alertId})`, 'success');
            }
            
            // Â¶ÇÊûúÂìçÂ∫îÂåÖÂê´ÊñπÊ≥ï‰ø°ÊÅØÔºåËÆ∞ÂΩïÂà∞ÊéßÂà∂Âè∞
            if (result.method) {
              console.log(`üìã ÊâßË°åÊñπÊ≥ï: ${result.method}`);
            }
            
          } catch (error) {
            console.error('ÁîüÊàêÊµãËØïÊä•Ë≠¶Â§±Ë¥•:', error);
            showStatusMessage('‚ùå ÁîüÊàêÂ§±Ë¥•: ' + error.message, 'error');
          } finally {
            // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
            button.disabled = false;
            button.innerHTML = originalText;
          }
        }

        // ÊòæÁ§∫Áä∂ÊÄÅÊ∂àÊÅØ
        function showStatusMessage(message, type) {
          if (statusMessage) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;
            statusMessage.style.display = 'inline-block';
            
            // 3ÁßíÂêéËá™Âä®ÈöêËóèÊàêÂäüÊ∂àÊÅØ
            if (type === 'success') {
              setTimeout(() => {
                statusMessage.style.display = 'none';
              }, 3000);
            }
          }
        }

        // Ê£ÄÊü•SSEËøûÊé•Áä∂ÊÄÅ
        async function checkSSEStatus() {
          try {
            showStatusMessage('Ê≠£Âú®Ê£ÄÊü•SSEËøûÊé•Áä∂ÊÄÅ...', 'info');
            
            // Ê£ÄÊü•ÊúçÂä°Âô®Á´ØÁöÑËøûÊé•ÁªüËÆ°
            const response = await fetch('/api/v1/alerts/sse/status');
            if (!response.ok) {
              throw new Error('Ëé∑ÂèñÊúçÂä°Âô®SSEÁä∂ÊÄÅÂ§±Ë¥•');
            }
            
            const data = await response.json();
            console.log('ÊúçÂä°Âô®SSEÁä∂ÊÄÅ:', data);
            
            // Ê£ÄÊü•ÂÆ¢Êà∑Á´ØËøûÊé•Áä∂ÊÄÅ
            const clientStatus = eventSource ? 
              (eventSource.readyState === EventSource.OPEN ? 'Â∑≤ËøûÊé•' : 
               eventSource.readyState === EventSource.CONNECTING ? 'ËøûÊé•‰∏≠' : 'Â∑≤Êñ≠ÂºÄ') : 'Êú™ËøûÊé•';
            
            // ÊûÑÂª∫ËØ¶ÁªÜÁä∂ÊÄÅ‰ø°ÊÅØ
            const statusInfo = {
              client: {
                status: clientStatus,
                connectionId: connectionId,
                readyState: eventSource ? eventSource.readyState : null,
                isConnecting: isConnecting,
                hasReconnectTimeout: !!reconnectTimeout
              },
              server: data,
              stats: connectionStats,
              page: {
                hidden: document.hidden,
                url: window.location.href,
                userAgent: navigator.userAgent.substring(0, 100)
              }
            };
            
            console.log('üîç ÂÆåÊï¥ËøûÊé•Áä∂ÊÄÅ:', statusInfo);
            
            const statusText = `üñ•Ô∏è ÂÆ¢Êà∑Á´Ø: ${clientStatus} | üåê ÊúçÂä°Âô®: ${data.connected_clients} ‰∏™ËøûÊé• | üìä ÊÄªËøûÊé•: ${connectionStats.totalConnections} Ê¨°`;
            showStatusMessage(statusText, 'success');
            
            // Â¶ÇÊûúËøûÊé•ÂºÇÂ∏∏È¢ëÁπÅÔºåÁªôÂá∫Ë≠¶Âëä
            if (connectionStats.totalConnections > 10) {
              console.warn('‚ö†Ô∏è Ê£ÄÊµãÂà∞ÂºÇÂ∏∏È¢ëÁπÅÁöÑËøûÊé•ÔºÅËøûÊé•ÁªüËÆ°:', connectionStats);
              showStatusMessage(`‚ö†Ô∏è Ë≠¶ÂëäÔºöÊ£ÄÊµãÂà∞ ${connectionStats.totalConnections} Ê¨°ËøûÊé•ÔºåÂèØËÉΩÂ≠òÂú®ÈóÆÈ¢ò`, 'error');
            }
            
          } catch (error) {
            console.error('Ê£ÄÊü•SSEËøûÊé•Áä∂ÊÄÅÂ§±Ë¥•:', error);
            showStatusMessage('‚ùå Ê£ÄÊü•Â§±Ë¥•: ' + error.message, 'error');
          }
        }

        // Â∫îÁî®ËøáÊª§Âô®
        async function applyFilters() {
          try {
            showStatusMessage('Ê≠£Âú®Â∫îÁî®ËøáÊª§Âô®...', 'info');
            
            // Ëé∑ÂèñËøáÊª§Êù°‰ª∂
            const status = document.getElementById('status-filter').value;
            const alertType = document.getElementById('alert-type-filter').value;
            const cameraName = document.getElementById('camera-filter').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            // ÊûÑÂª∫Êü•ËØ¢ÂèÇÊï∞
            const params = new URLSearchParams();
            if (status) params.append('status', status);
            if (alertType) params.append('alert_type', alertType);
            if (cameraName) params.append('camera_name', cameraName);
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            params.append('limit', '50'); // ÈôêÂà∂ËøîÂõûÊï∞Èáè
            
            console.log('üîç Â∫îÁî®ËøáÊª§Âô®:', Object.fromEntries(params));
            
            const response = await fetch(`/api/v1/alerts/real-time?${params}`);
            if (!response.ok) {
              throw new Error('Ëé∑ÂèñËøáÊª§ÁªìÊûúÂ§±Ë¥•');
            }
            
            const data = await response.json();
            const alerts = data.alerts || [];
            
            // Ê∏ÖÁ©∫ÂÆπÂô®Âπ∂ÊòæÁ§∫ÁªìÊûú
            if (alertContainer) {
              alertContainer.innerHTML = '';
            }
            
            if (alerts.length === 0) {
              alertContainer.innerHTML = '<div class="no-alerts"><p>Ê≤°ÊúâÁ¨¶ÂêàÊù°‰ª∂ÁöÑÊä•Ë≠¶Êï∞ÊçÆ</p></div>';
              alertCount = 0;
            } else {
              alerts.forEach(alert => {
                const alertElement = createAlertElement(alert);
                alertContainer.appendChild(alertElement);
              });
              alertCount = alerts.length;
            }
            
            if (alertCountElement) {
              alertCountElement.textContent = alertCount;
            }
            
            const summary = data.summary || {};
            showStatusMessage(`ËøáÊª§ÂÆåÊàê: ÊòæÁ§∫ ${alerts.length} Êù°ËÆ∞ÂΩïÔºåÂÖ± ${summary.total_count || 0} Êù°Á¨¶ÂêàÊù°‰ª∂`, 'success');
            
          } catch (error) {
            console.error('Â∫îÁî®ËøáÊª§Âô®Â§±Ë¥•:', error);
            showStatusMessage('ËøáÊª§Â§±Ë¥•: ' + error.message, 'error');
          }
        }
        
        // üÜï Ê∏ÖÁ©∫ËøáÊª§Âô®
        function clearFilters() {
          document.getElementById('status-filter').value = '';
          document.getElementById('alert-type-filter').value = '';
          document.getElementById('camera-filter').value = '';
          document.getElementById('start-date').value = '';
          document.getElementById('end-date').value = '';
          
          // ÈáçÊñ∞Âä†ËΩΩÂéÜÂè≤Êï∞ÊçÆ
          loadHistoricalAlerts();
          showStatusMessage('ËøáÊª§Âô®Â∑≤Ê∏ÖÁ©∫', 'info');
        }
        
        // Êõ¥Êñ∞Êä•Ë≠¶Áä∂ÊÄÅ
        async function updateAlertStatus(alertId, newStatus) {
          try {
            // Â∞ÜÊï¥Êï∞Áä∂ÊÄÅËΩ¨Êç¢‰∏∫ÊòæÁ§∫ÂêçÁß∞Áî®‰∫éÊèêÁ§∫
            const statusDisplayMap = {
              1: 'ÂæÖÂ§ÑÁêÜ', 2: 'Â§ÑÁêÜ‰∏≠', 3: 'Â∑≤Â§ÑÁêÜ', 4: 'Â∑≤ÂøΩÁï•', 5: 'Â∑≤ËøáÊúü'
            };
            const statusDisplay = statusDisplayMap[newStatus];
            
            showStatusMessage(`Ê≠£Âú®Êõ¥Êñ∞Êä•Ë≠¶ ${alertId} Áä∂ÊÄÅ‰∏∫ ${statusDisplay}...`, 'info');
            
            const response = await fetch(`/api/v1/alerts/${alertId}/status`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                status: newStatus,
                processed_by: 'ÂâçÁ´ØÁî®Êà∑', // ÂèØ‰ª•‰ªéÁî®Êà∑‰ø°ÊÅØËé∑Âèñ
                processing_notes: `ÈÄöËøáÂâçÁ´ØÁïåÈù¢Êõ¥Êñ∞Áä∂ÊÄÅ‰∏∫: ${statusDisplay}`
              })
            });
            
            if (!response.ok) {
              throw new Error('Êõ¥Êñ∞Áä∂ÊÄÅÂ§±Ë¥•');
            }
            
            const updatedAlert = await response.json();
            console.log('‚úÖ Áä∂ÊÄÅÊõ¥Êñ∞ÊàêÂäü:', updatedAlert);
            
            // Êõ¥Êñ∞È°µÈù¢‰∏äÁöÑÊä•Ë≠¶ÂÖÉÁ¥†
            const alertElement = document.querySelector(`[data-alert-id="${alertId}"]`);
            if (alertElement) {
              // ÈáçÊñ∞ÂàõÂª∫ÂÖÉÁ¥†‰ª•ÂèçÊò†Êñ∞Áä∂ÊÄÅ
              const newAlertElement = createAlertElement(updatedAlert);
              alertElement.parentNode.replaceChild(newAlertElement, alertElement);
            }
            
            showStatusMessage(`Êä•Ë≠¶ ${alertId} Áä∂ÊÄÅÂ∑≤Êõ¥Êñ∞‰∏∫ ${statusDisplay}`, 'success');
            
          } catch (error) {
            console.error('Êõ¥Êñ∞Áä∂ÊÄÅÂ§±Ë¥•:', error);
            showStatusMessage('Êõ¥Êñ∞Áä∂ÊÄÅÂ§±Ë¥•: ' + error.message, 'error');
          }
        }
        
        // üÜï ÊòæÁ§∫ÁªüËÆ°‰ø°ÊÅØ
        async function showStatistics() {
          try {
            showStatusMessage('Ê≠£Âú®Ëé∑ÂèñÁªüËÆ°‰ø°ÊÅØ...', 'info');
            
            const response = await fetch('/api/v1/alerts/statistics');
            if (!response.ok) {
              throw new Error('Ëé∑ÂèñÁªüËÆ°‰ø°ÊÅØÂ§±Ë¥•');
            }
            
            const stats = await response.json();
            console.log('üìä ÁªüËÆ°‰ø°ÊÅØ:', stats);
            
            // ÊûÑÂª∫ÁªüËÆ°‰ø°ÊÅØÊòæÁ§∫
            const statusDist = stats.status_distribution || {};
            const typeDist = stats.type_distribution || {};
            const levelDist = stats.level_distribution || {};
            
            const statsHtml = `
              <div style="padding: 20px; background: white; border-radius: 6px; margin: 10px 0; border: 1px solid #d9d9d9;">
                <h3>üìä Êä•Ë≠¶ÁªüËÆ°‰ø°ÊÅØ</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                  <div>
                    <h4>üìà Áä∂ÊÄÅÂàÜÂ∏É</h4>
                    <ul style="list-style: none; padding: 0;">
                      <li>‚è≥ ÂæÖÂ§ÑÁêÜ: ${statusDist['ÂæÖÂ§ÑÁêÜ'] || 0} Êù°</li>
                      <li>üîÑ Â§ÑÁêÜ‰∏≠: ${statusDist['Â§ÑÁêÜ‰∏≠'] || 0} Êù°</li>
                      <li>‚úÖ Â∑≤Â§ÑÁêÜ: ${statusDist['Â∑≤Â§ÑÁêÜ'] || 0} Êù°</li>
                      <li>üö´ Â∑≤ÂøΩÁï•: ${statusDist['Â∑≤ÂøΩÁï•'] || 0} Êù°</li>
                      <li>‚è∞ Â∑≤ËøáÊúü: ${statusDist['Â∑≤ËøáÊúü'] || 0} Êù°</li>
                    </ul>
                  </div>
                  <div>
                    <h4>üè∑Ô∏è Á±ªÂûãÂàÜÂ∏É</h4>
                    <ul style="list-style: none; padding: 0;">
                      ${Object.entries(typeDist).map(([type, count]) => 
                        `<li>${ALERT_TYPES[type] || type}: ${count} Êù°</li>`
                      ).join('')}
                    </ul>
                  </div>
                  <div>
                    <h4>‚ö° Á≠âÁ∫ßÂàÜÂ∏É</h4>
                    <ul style="list-style: none; padding: 0;">
                      ${Object.entries(levelDist).map(([level, count]) => 
                        `<li>Á≠âÁ∫ß ${level}: ${count} Êù°</li>`
                      ).join('')}
                    </ul>
                  </div>
                </div>
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #f0f0f0;">
                  <strong>üìä ÊÄªËÆ°: ${stats.total_alerts || 0} Êù°Êä•Ë≠¶</strong>
                </div>
                <button onclick="this.parentElement.remove()" style="margin-top: 10px; padding: 5px 10px; background: #f5f5f5; border: 1px solid #d9d9d9; border-radius: 3px; cursor: pointer;">ÂÖ≥Èó≠</button>
              </div>
            `;
            
            // Âú®Êä•Ë≠¶ÂÆπÂô®ÂâçÊèíÂÖ•ÁªüËÆ°‰ø°ÊÅØ
            const statsDiv = document.createElement('div');
            statsDiv.innerHTML = statsHtml;
            alertContainer.parentNode.insertBefore(statsDiv, alertContainer);
            
            showStatusMessage('ÁªüËÆ°‰ø°ÊÅØÂ∑≤ÊòæÁ§∫', 'success');
            
          } catch (error) {
            console.error('Ëé∑ÂèñÁªüËÆ°‰ø°ÊÅØÂ§±Ë¥•:', error);
            showStatusMessage('Ëé∑ÂèñÁªüËÆ°‰ø°ÊÅØÂ§±Ë¥•: ' + error.message, 'error');
          }
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
          console.log('üöÄ Êä•Ë≠¶ÁõëÊéßÈ°µÈù¢ÂàùÂßãÂåñÂºÄÂßã');
          
          // Ëé∑ÂèñDOMÂÖÉÁ¥†
          alertContainer = document.getElementById('alert-container');
          connectionStatus = document.getElementById('connection-status');
          alertCountElement = document.getElementById('alert-count');
          connectionIdElement = document.getElementById('connection-id');
          cameraFilter = document.getElementById('camera-filter');
          alertTypeFilter = document.getElementById('alert-type-filter');
          statusMessage = document.getElementById('status-message');
          
          // üÜï Ëé∑ÂèñÊñ∞ÁöÑËøáÊª§Âô®ÂÖÉÁ¥†
          statusFilter = document.getElementById('status-filter');
          startDateFilter = document.getElementById('start-date');
          endDateFilter = document.getElementById('end-date');
          cameraNameFilter = document.getElementById('camera-filter');
          
          // ÂàùÂßãÂåñËøáÊª§Âô®‰∫ã‰ª∂
          if (cameraFilter) {
            cameraFilter.addEventListener('change', filterAlerts);
          }
          
          if (alertTypeFilter) {
            alertTypeFilter.addEventListener('change', filterAlerts);
          }
          
          // ËøûÊé•Âà∞SSE
          connectSSE();
          
          // Âä†ËΩΩÂéÜÂè≤Êä•Ë≠¶Êï∞ÊçÆ
          loadHistoricalAlerts();
          
          // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
          const testButton = document.getElementById('send-test-alert');
          if (testButton) {
            testButton.addEventListener('click', sendTestAlert);
          }
          
          const refreshButton = document.getElementById('refresh-alerts');
          if (refreshButton) {
            refreshButton.addEventListener('click', function() {
              console.log('üîÑ ÊâãÂä®Âà∑Êñ∞Êä•Ë≠¶Êï∞ÊçÆ');
              loadHistoricalAlerts();
            });
          }
          
          const statusButton = document.getElementById('check-sse-status');
          if (statusButton) {
            statusButton.addEventListener('click', function() {
              checkConnectionStatus();
            });
          }
          
          // üÜï Ê∑ªÂä†ÁªüËÆ°‰ø°ÊÅØÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
          const statisticsButton = document.getElementById('show-statistics');
          if (statisticsButton) {
            statisticsButton.addEventListener('click', showStatistics);
          }
          
          console.log('‚úÖ Êä•Ë≠¶ÁõëÊéßÈ°µÈù¢ÂàùÂßãÂåñÂÆåÊàê');
        });
    </script>
</body>
</html> 