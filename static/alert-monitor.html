<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘ç›‘æ§æŠ¥è­¦ç³»ç»Ÿ</title>
    <style>
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
        }
        
        .header {
            background-color: #262f3e;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.5rem;
        }
        
        .status-bar {
            background-color: #f9f9f9;
            padding: 10px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .connected {
            color: #52c41a;
        }
        
        .disconnected {
            color: #f5222d;
        }
        
        .alert-count {
            background-color: #1890ff;
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 0.8rem;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-size: 0.9rem;
            font-weight: bold;
            color: #555;
        }
        
        .filter-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            min-width: 150px;
        }
        
        .filter-input:focus {
            outline: none;
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }
        
        .filter-button {
            background-color: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }
        
        .filter-button:hover {
            background-color: #096dd9;
        }
        
        .clear-filter {
            background-color: #f5f5f5;
            color: #666;
        }
        
        .clear-filter:hover {
            background-color: #e8e8e8;
        }
        
        .content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .alert-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .alert-item {
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            border-left: 4px solid #ff4d4f;
            transition: all 0.3s ease;
        }
        
        .alert-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        .alert-header {
            display: flex;
            justify-content: space-between;
            padding: 12px 15px;
            background-color: #fafafa;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .alert-type {
            font-weight: bold;
            color: #ff4d4f;
        }
        
        .alert-time {
            color: #888;
            font-size: 0.9rem;
        }
        
        .alert-body {
            padding: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .alert-info {
            flex: 1;
            min-width: 250px;
        }
        
        .alert-info p {
            margin: 5px 0;
            line-height: 1.5;
        }
        
        .alert-image {
            flex: 1;
            min-width: 250px;
            max-width: 500px;
        }
        
        .alert-image img {
            width: 100%;
            border-radius: 4px;
            object-fit: cover;
        }
        
        .alert-footer {
            padding: 10px 15px;
            border-top: 1px solid #f0f0f0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .alert-video-link {
            color: #1890ff;
            text-decoration: none;
            padding: 5px 10px;
        }
        
        .alert-video-link:hover {
            text-decoration: underline;
        }
        
        .alert-dismiss {
            background-color: #f0f0f0;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
        }
        
        .alert-dismiss:hover {
            background-color: #e0e0e0;
        }
        
        .no-alerts {
            text-align: center;
            padding: 50px;
            color: #999;
        }
        
        /* æŠ¥è­¦ç±»å‹æ ·å¼ */
        .alert-type-no_helmet {
            border-left-color: #ff4d4f;
        }
        
        .alert-type-intrusion {
            border-left-color: #ff7a45;
        }
        
        .alert-type-fire {
            border-left-color: #ff4d4f;
        }
        
        .alert-type-smoke {
            border-left-color: #ffa940;
        }
        
        .alert-type-loitering {
            border-left-color: #faad14;
        }
        
        .alert-type-abnormal_behavior {
            border-left-color: #faad14;
        }
        
        .alert-type-test_alert {
            border-left-color: #1890ff;
        }
        
        .actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .test-button {
            background-color: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .test-button:hover {
            background-color: #096dd9;
        }
        
        .test-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .status-message {
            padding: 8px 12px;
            border-radius: 4px;
            margin-left: 10px;
            display: none;
        }
        
        .status-message.success {
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }
        
        .status-message.error {
            background-color: #fff1f0;
            border: 1px solid #ffa39e;
            color: #ff4d4f;
        }
        
        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
            margin-right: 5px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media screen and (max-width: 768px) {
            .status-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .filters {
                width: 100%;
                justify-content: space-between;
            }
        }
        
        /* ğŸ†• çŠ¶æ€æ ‡ç­¾æ ·å¼ */
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            text-align: center;
            min-width: 60px;
        }
        
        .status-pending {
            background-color: #fff2e8;
            color: #d46b08;
            border: 1px solid #ffbb96;
        }
        
        .status-processing {
            background-color: #e6f7ff;
            color: #096dd9;
            border: 1px solid #91d5ff;
        }
        
        .status-resolved {
            background-color: #f6ffed;
            color: #389e0d;
            border: 1px solid #b7eb8f;
        }
        
        .status-archived {
            background-color: #f5f5f5;
            color: #8c8c8c;
            border: 1px solid #d9d9d9;
        }
        
        .status-false-alarm {
            background-color: #fff2f0;
            color: #cf1322;
            border: 1px solid #ffccc7;
        }
        
        /* ğŸ†• çŠ¶æ€æ“ä½œæŒ‰é’® */
        .status-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        
        .status-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .status-btn-process {
            background-color: #1890ff;
            color: white;
        }
        
        .status-btn-resolve {
            background-color: #52c41a;
            color: white;
        }
        
        /* ğŸ†• æ£€æµ‹ç»“æœæ ·å¼ */
        .detection-results {
            margin-top: 15px;
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #1890ff;
        }
        
        .detection-results h4 {
            margin: 0 0 10px 0;
            color: #1890ff;
            font-size: 0.9rem;
        }
        
        .detection-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .detection-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background-color: white;
            border-radius: 4px;
            border: 1px solid #e8e8e8;
            flex-wrap: wrap;
        }
        
        .detection-name {
            font-weight: bold;
            color: #262626;
            min-width: 80px;
        }
        
        .detection-score {
            background-color: #52c41a;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8rem;
            font-weight: bold;
            min-width: 50px;
            text-align: center;
        }
        
        .detection-location {
            color: #666;
            font-size: 0.85rem;
            flex: 1;
            min-width: 200px;
        }
        
        /* ğŸ†• ç”µå­å›´æ ä¿¡æ¯æ ·å¼ */
        .fence-info {
            margin-top: 10px;
            padding: 8px 12px;
            background-color: #fff7e6;
            border-radius: 4px;
            border-left: 3px solid #faad14;
        }
        
        .fence-info p {
            margin: 0;
            color: #d46b08;
            font-size: 0.9rem;
        }
        
        .status-btn-archive {
            background-color: #8c8c8c;
            color: white;
        }
        
        .status-btn-false-alarm {
            background-color: #f5222d;
            color: white;
        }
        
        .status-btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <!-- æŠ¥è­¦éŸ³æ•ˆ -->
    <audio id="alert-sound" src="/static/sound/alert.mp3" preload="auto"></audio>
    
    <!-- é¡µé¢å¤´éƒ¨ -->
    <header class="header">
        <h1>è§†é¢‘ç›‘æ§æŠ¥è­¦ç³»ç»Ÿ</h1>
    </header>
    
    <!-- çŠ¶æ€æ  -->
    <div class="status-bar">
        <div class="status-item">
            <span>SSEè¿æ¥:</span>
            <span id="connection-status" class="disconnected">æœªè¿æ¥</span>
        </div>
        
        <div class="status-item">
            <span>æŠ¥è­¦æ•°é‡:</span>
            <span id="alert-count" class="alert-count">0</span>
        </div>
        
        <div class="status-item">
            <span>è¿æ¥ID:</span>
            <span id="connection-id" class="alert-count">-</span>
        </div>
        
        <div class="filters">
            <select id="camera-filter">
                <option value="">æ‰€æœ‰æ‘„åƒå¤´</option>
                <option value="camera_01">æ‘„åƒå¤´ 1</option>
                <option value="camera_02">æ‘„åƒå¤´ 2</option>
                <option value="camera_03">æ‘„åƒå¤´ 3</option>
            </select>
            
            <select id="alert-type-filter">
                <option value="">æ‰€æœ‰æŠ¥è­¦ç±»å‹</option>
                <option value="no_helmet">æœªä½©æˆ´å®‰å…¨å¸½</option>
                <option value="intrusion">å…¥ä¾µè­¦å‘Š</option>
                <option value="fire">ç«ç¾è­¦å‘Š</option>
                <option value="smoke">çƒŸé›¾è­¦å‘Š</option>
                <option value="loitering">å¾˜å¾Šè¡Œä¸º</option>
                <option value="abnormal_behavior">å¼‚å¸¸è¡Œä¸º</option>
            </select>
        </div>
    </div>
    
    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="content">
        <!-- ğŸ†• è¿‡æ»¤å™¨åŒºåŸŸ -->
        <div class="filters">
            <div class="filter-group">
                <label for="status-filter">æŠ¥è­¦çŠ¶æ€</label>
                            <select id="status-filter" class="filter-input">
                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                <option value="1">å¾…å¤„ç†</option>
                <option value="2">å¤„ç†ä¸­</option>
                <option value="3">å·²å¤„ç†</option>
                <option value="4">å·²å½’æ¡£</option>
                <option value="5">è¯¯æŠ¥</option>
            </select>
            </div>
            
            <div class="filter-group">
                <label for="alert-type-filter">æŠ¥è­¦ç±»å‹</label>
                <select id="alert-type-filter" class="filter-input">
                    <option value="">å…¨éƒ¨ç±»å‹</option>
                    <option value="no_helmet">æœªä½©æˆ´å®‰å…¨å¸½</option>
                    <option value="intrusion">å…¥ä¾µè­¦å‘Š</option>
                    <option value="fire">ç«ç¾è­¦å‘Š</option>
                    <option value="smoke">çƒŸé›¾è­¦å‘Š</option>
                    <option value="loitering">å¾˜å¾Šè¡Œä¸º</option>
                    <option value="abnormal_behavior">å¼‚å¸¸è¡Œä¸º</option>
                    <option value="test_alert">æµ‹è¯•æŠ¥è­¦</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="camera-filter">æ‘„åƒå¤´</label>
                <input type="text" id="camera-filter" class="filter-input" placeholder="æ‘„åƒå¤´åç§°æˆ–ID">
            </div>
            
            <div class="filter-group">
                <label for="start-date">å¼€å§‹æ—¥æœŸ</label>
                <input type="date" id="start-date" class="filter-input">
            </div>
            
            <div class="filter-group">
                <label for="end-date">ç»“æŸæ—¥æœŸ</label>
                <input type="date" id="end-date" class="filter-input">
            </div>
            
            <div class="filter-group">
                <label>&nbsp;</label>
                <div style="display: flex; gap: 10px;">
                    <button class="filter-button" onclick="applyFilters()">ğŸ” ç­›é€‰</button>
                    <button class="filter-button clear-filter" onclick="clearFilters()">ğŸ”„ æ¸…ç©º</button>
                </div>
            </div>
        </div>
        
        <div class="actions">
            <div>
                <button id="send-test-alert" class="test-button">ğŸ¯ ç”Ÿæˆæµ‹è¯•æŠ¥è­¦</button>
                <span id="status-message" class="status-message"></span>
            </div>
            <div>
                <button id="refresh-alerts" class="test-button" style="background-color: #52c41a;">ğŸ”„ åˆ·æ–°æŠ¥è­¦</button>
                <button id="check-sse-status" class="test-button" style="background-color: #1890ff;">ğŸ“Š è¿æ¥çŠ¶æ€</button>
                <button id="show-statistics" class="test-button" style="background-color: #722ed1;">ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯</button>
            </div>
        </div>
        
        <div id="alert-container" class="alert-container">
            <div class="no-alerts">
                <p>ç­‰å¾…æŠ¥è­¦æ•°æ®...</p>
            </div>
        </div>
    </div>
    
    <script>
        // æŠ¥è­¦ç±»å‹å’Œå¯¹åº”çš„æ˜¾ç¤ºæ–‡æœ¬
        const ALERT_TYPES = {
          'no_helmet': 'æœªä½©æˆ´å®‰å…¨å¸½',
          'intrusion': 'å…¥ä¾µè­¦å‘Š',
          'fire': 'ç«ç¾è­¦å‘Š',
          'smoke': 'çƒŸé›¾è­¦å‘Š',
          'loitering': 'å¾˜å¾Šè¡Œä¸º',
          'abnormal_behavior': 'å¼‚å¸¸è¡Œä¸º',
          'test_alert': 'æµ‹è¯•æŠ¥è­¦'
        };

        // çŠ¶æ€æ˜ å°„å’Œæ ·å¼ - åªæ”¯æŒæ•´æ•°ç±»å‹
        const ALERT_STATUSES = {
          1: { class: 'status-pending', icon: 'â³', display: 'å¾…å¤„ç†' },
          2: { class: 'status-processing', icon: 'ğŸ”„', display: 'å¤„ç†ä¸­' },
          3: { class: 'status-resolved', icon: 'âœ…', display: 'å·²å¤„ç†' },
          4: { class: 'status-archived', icon: 'ğŸ“‚', display: 'å·²å½’æ¡£' },
          5: { class: 'status-false-alarm', icon: 'âŒ', display: 'è¯¯æŠ¥' }
        };

        // è·å–çŠ¶æ€ä¿¡æ¯çš„è¾…åŠ©å‡½æ•°
        function getStatusInfo(status) {
          return ALERT_STATUSES[status] || ALERT_STATUSES[1];
        }

        // å…¨å±€å˜é‡
        let eventSource = null;
        let alertCount = 0;
        let reconnectTimeout = null;
        let connectionId = null;
        let isConnecting = false;
        const MAX_ALERTS = 100; // æœ€å¤šæ˜¾ç¤ºçš„æŠ¥è­¦æ•°é‡
        
        // æ·»åŠ è¿æ¥ç»Ÿè®¡
        let connectionStats = {
          totalConnections: 0,
          totalReconnects: 0,
          lastConnectTime: null,
          lastDisconnectTime: null,
          connectionHistory: []
        };

        // DOMå…ƒç´ 
        let alertContainer;
        let connectionStatus;
        let alertCountElement;
        let connectionIdElement;
        let cameraFilter;
        let alertTypeFilter;
        let statusMessage;
        // ğŸ†• æ–°å¢è¿‡æ»¤å™¨å…ƒç´ 
        let statusFilter;
        let startDateFilter;
        let endDateFilter;
        let cameraNameFilter;

        // ç”Ÿæˆå”¯ä¸€è¿æ¥ID
        function generateConnectionId() {
            return 'conn_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // åˆå§‹åŒ–å‡½æ•°
        function initAlertMonitor() {
          console.log('åˆå§‹åŒ–æŠ¥è­¦ç›‘æ§ç³»ç»Ÿ...');
          
          // ç”Ÿæˆè¿æ¥ID
          connectionId = generateConnectionId();
          
          // è·å–DOMå…ƒç´ 
          alertContainer = document.getElementById('alert-container');
          connectionStatus = document.getElementById('connection-status');
          alertCountElement = document.getElementById('alert-count');
          connectionIdElement = document.getElementById('connection-id');
          cameraFilter = document.getElementById('camera-filter');
          alertTypeFilter = document.getElementById('alert-type-filter');
          statusMessage = document.getElementById('status-message');
          
          // æ˜¾ç¤ºè¿æ¥ID
          if (connectionIdElement) {
            connectionIdElement.textContent = connectionId.substr(-8);
          }
          
          // åˆå§‹åŒ–è¿‡æ»¤å™¨äº‹ä»¶
          if (cameraFilter) {
            cameraFilter.addEventListener('change', filterAlerts);
          }
          
          if (alertTypeFilter) {
            alertTypeFilter.addEventListener('change', filterAlerts);
          }
          
          // è¿æ¥åˆ°SSE
          connectSSE();
          
          // åŠ è½½å†å²æŠ¥è­¦æ•°æ®
          loadHistoricalAlerts();
          
          // æ·»åŠ æµ‹è¯•æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
          const testButton = document.getElementById('send-test-alert');
          if (testButton) {
            testButton.addEventListener('click', sendTestAlert);
          }
          
          // æ·»åŠ åˆ·æ–°æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
          const refreshButton = document.getElementById('refresh-alerts');
          if (refreshButton) {
            refreshButton.addEventListener('click', loadHistoricalAlerts);
          }
          
          // æ·»åŠ è¿æ¥çŠ¶æ€æ£€æŸ¥æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
          const checkStatusButton = document.getElementById('check-sse-status');
          if (checkStatusButton) {
            checkStatusButton.addEventListener('click', checkSSEStatus);
          }
          
          // é¡µé¢å¸è½½æ—¶æ¸…ç†è¿æ¥
          window.addEventListener('beforeunload', function() {
            cleanupConnection();
          });
          
          // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶ç®¡ç†è¿æ¥
          document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
              console.log('é¡µé¢éšè—ï¼Œæš‚åœé‡è¿');
              // ğŸ”§ ä¼˜åŒ–ï¼šé¡µé¢éšè—æ—¶å–æ¶ˆé‡è¿è®¡æ—¶å™¨ï¼Œä½†ä¸å…³é—­è¿æ¥
              if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
                reconnectTimeout = null;
                console.log('å·²å–æ¶ˆé‡è¿è®¡æ—¶å™¨');
              }
            } else {
              console.log('é¡µé¢æ˜¾ç¤ºï¼Œæ£€æŸ¥è¿æ¥çŠ¶æ€');
              // ğŸ”§ ä¼˜åŒ–ï¼šæ›´ä¸¥æ ¼çš„è¿æ¥çŠ¶æ€æ£€æŸ¥
              if (!eventSource) {
                console.log('ğŸ”„ eventSourceä¸å­˜åœ¨ï¼Œå»ºç«‹æ–°è¿æ¥');
                connectSSE();
              } else if (eventSource.readyState === EventSource.CLOSED) {
                console.log('ğŸ”„ è¿æ¥å·²å…³é—­ï¼Œå»ºç«‹æ–°è¿æ¥');
                connectSSE();
              } else if (eventSource.readyState === EventSource.CONNECTING) {
                console.log('â³ è¿æ¥æ­£åœ¨å»ºç«‹ä¸­ï¼Œç­‰å¾…...');
              } else if (eventSource.readyState === EventSource.OPEN) {
                console.log('âœ… è¿æ¥æ­£å¸¸ï¼Œæ— éœ€é‡æ–°è¿æ¥');
              }
            }
          });
        }

        // æ¸…ç†è¿æ¥
        function cleanupConnection() {
          console.log('æ¸…ç†SSEè¿æ¥:', connectionId);
          
          if (reconnectTimeout) {
            clearTimeout(reconnectTimeout);
            reconnectTimeout = null;
          }
          
          if (eventSource) {
            eventSource.close();
            eventSource = null;
          }
          
          isConnecting = false;
        }

        // è¿æ¥åˆ°SSEæœåŠ¡å™¨
        function connectSSE() {
          // ğŸ”§ ä¼˜åŒ–ï¼šæ›´ä¸¥æ ¼çš„é‡å¤è¿æ¥æ£€æŸ¥
          if (isConnecting) {
            console.log('âš ï¸ æ­£åœ¨è¿æ¥ä¸­ï¼Œè·³è¿‡é‡å¤è¿æ¥è¯·æ±‚');
            return;
          }
          
          // ğŸ”§ ä¼˜åŒ–ï¼šæ£€æŸ¥ç°æœ‰è¿æ¥çŠ¶æ€ï¼ŒåŒ…æ‹¬CONNECTINGçŠ¶æ€
          if (eventSource) {
            if (eventSource.readyState === EventSource.OPEN) {
              console.log('âœ… SSEè¿æ¥å·²å­˜åœ¨ä¸”æ­£å¸¸ï¼Œæ— éœ€é‡æ–°è¿æ¥');
              return;
            } else if (eventSource.readyState === EventSource.CONNECTING) {
              console.log('â³ SSEè¿æ¥æ­£åœ¨å»ºç«‹ä¸­ï¼Œç­‰å¾…å®Œæˆ...');
              return;
            }
          }
          
          // æ¸…ç†æ—§è¿æ¥
          cleanupConnection();
          
          isConnecting = true;
          console.log('ğŸ”— å¼€å§‹å»ºç«‹SSEè¿æ¥:', connectionId);
          console.log('ğŸ” è°ƒç”¨æ ˆ:', new Error().stack);  // æ·»åŠ è°ƒç”¨æ ˆè·Ÿè¸ª
          
          // è®°å½•è¿æ¥ç»Ÿè®¡
          connectionStats.totalConnections++;
          connectionStats.lastConnectTime = new Date();
          connectionStats.connectionHistory.push({
            type: 'connect_attempt',
            time: new Date(),
            connectionId: connectionId
          });
          
          // ä¿æŒå†å²è®°å½•åœ¨åˆç†èŒƒå›´å†…
          if (connectionStats.connectionHistory.length > 50) {
            connectionStats.connectionHistory = connectionStats.connectionHistory.slice(-50);
          }
          
          console.log('ğŸ“Š è¿æ¥ç»Ÿè®¡:', connectionStats);
          
          // æ›´æ–°çŠ¶æ€
          updateConnectionStatus('æ­£åœ¨è¿æ¥...');
          
          // åˆ›å»ºæ–°è¿æ¥
          eventSource = new EventSource('/api/v1/alerts/stream');
          
          // è¿æ¥æ‰“å¼€äº‹ä»¶
          eventSource.addEventListener('open', function() {
            console.log('âœ… SSEè¿æ¥å·²å»ºç«‹:', connectionId);
            updateConnectionStatus('å·²è¿æ¥');
            isConnecting = false;
            
            // å–æ¶ˆé‡è¿è®¡æ—¶å™¨
            if (reconnectTimeout) {
              clearTimeout(reconnectTimeout);
              reconnectTimeout = null;
            }
          });
          
          // æ¶ˆæ¯äº‹ä»¶
          eventSource.addEventListener('message', function(event) {
            try {
              const data = JSON.parse(event.data);
              
              // å¦‚æœæ˜¯è¿æ¥æˆåŠŸæ¶ˆæ¯ï¼Œå¿½ç•¥
              if (data.event === 'connected') {
                console.log('ğŸ“¡ æ”¶åˆ°SSEè¿æ¥ç¡®è®¤æ¶ˆæ¯');
                return;
              }
              
              // å¤„ç†æŠ¥è­¦æ¶ˆæ¯
              console.log('ğŸš¨ æ”¶åˆ°SSEæŠ¥è­¦æ¶ˆæ¯:', data);
              handleAlertMessage(data);
              
            } catch (error) {
              console.error('âŒ è§£ææŠ¥è­¦æ¶ˆæ¯å¤±è´¥:', error, event.data);
            }
          });
          
          // é”™è¯¯äº‹ä»¶
          eventSource.addEventListener('error', function(event) {
            console.log('âŒ SSEè¿æ¥é”™è¯¯:', event);
            console.log('ğŸ” é”™è¯¯æ—¶è¿æ¥çŠ¶æ€:', eventSource ? eventSource.readyState : 'null');
            console.log('ğŸ” é¡µé¢å¯è§æ€§:', document.hidden ? 'éšè—' : 'å¯è§');
            
            // è®°å½•æ–­å¼€ç»Ÿè®¡
            connectionStats.lastDisconnectTime = new Date();
            connectionStats.connectionHistory.push({
              type: 'disconnect',
              time: new Date(),
              connectionId: connectionId,
              readyState: eventSource ? eventSource.readyState : null
            });
            
            updateConnectionStatus('è¿æ¥æ–­å¼€');
            isConnecting = false;
            
            // ğŸ”§ ä¼˜åŒ–ï¼šæ›´ç²¾ç¡®çš„é‡è¿æ¡ä»¶åˆ¤æ–­
            if (eventSource && eventSource.readyState === EventSource.CLOSED) {
              // åªæœ‰åœ¨é¡µé¢å¯è§ã€æ— é‡è¿è®¡æ—¶å™¨ä¸”è¿æ¥çœŸæ­£å…³é—­æ—¶æ‰é‡è¿
              if (!document.hidden && !reconnectTimeout) {
                console.log('â³ 10ç§’åå°è¯•é‡è¿...');
                connectionStats.totalReconnects++;
                reconnectTimeout = setTimeout(() => {
                  console.log('ğŸ”„ æ‰§è¡Œé‡è¿...');
                  reconnectTimeout = null;
                  // ğŸ”§ ä¼˜åŒ–ï¼šé‡è¿å‰å†æ¬¡æ£€æŸ¥è¿æ¥çŠ¶æ€
                  if (!eventSource || eventSource.readyState === EventSource.CLOSED) {
                    connectSSE();
                  } else {
                    console.log('ğŸš« è¿æ¥çŠ¶æ€å·²æ¢å¤ï¼Œå–æ¶ˆé‡è¿');
                  }
                }, 10000); // å¢åŠ é‡è¿é—´éš”åˆ°10ç§’
              } else {
                console.log('ğŸš« è·³è¿‡é‡è¿ - é¡µé¢éšè—:', document.hidden, 'æˆ–å·²æœ‰é‡è¿è®¡æ—¶å™¨:', !!reconnectTimeout);
              }
            } else {
              console.log('ğŸ” è¿æ¥çŠ¶æ€éCLOSEDï¼Œç­‰å¾…çŠ¶æ€å˜åŒ–...');
            }
          });
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
        function updateConnectionStatus(status) {
          if (connectionStatus) {
            connectionStatus.textContent = status;
            connectionStatus.className = status === 'å·²è¿æ¥' ? 'connected' : 'disconnected';
          }
        }

        // å¤„ç†æŠ¥è­¦æ¶ˆæ¯
        function handleAlertMessage(alert) {
          console.log('å¤„ç†æŠ¥è­¦æ¶ˆæ¯:', alert);
          
          // ğŸ†• è°ƒè¯•æ–°å­—æ®µæ ¼å¼
          if (alert.electronic_fence) {
            console.log('ğŸš§ æ”¶åˆ°ç”µå­å›´æ æ•°æ®:', alert.electronic_fence);
          }
          if (alert.result && Array.isArray(alert.result)) {
            console.log('ğŸ¯ æ”¶åˆ°æ£€æµ‹ç»“æœæ•°æ®:', alert.result.length + 'ä¸ªå¯¹è±¡');
          }
          
          // åˆ›å»ºæŠ¥è­¦å…ƒç´ 
          const alertElement = createAlertElement(alert);
          
          // æ¸…é™¤"ç­‰å¾…æŠ¥è­¦æ•°æ®"æç¤º
          const noAlertsElement = alertContainer.querySelector('.no-alerts');
          if (noAlertsElement) {
            noAlertsElement.remove();
          }
          
          // æ·»åŠ åˆ°å®¹å™¨é¡¶éƒ¨
          if (alertContainer) {
            alertContainer.insertBefore(alertElement, alertContainer.firstChild);
            
            // å¦‚æœæŠ¥è­¦å¤ªå¤šï¼Œç§»é™¤æ—§çš„
            while (alertContainer.children.length > MAX_ALERTS) {
              alertContainer.removeChild(alertContainer.lastChild);
            }
          }
          
          // ğŸ”§ ä¿®å¤ï¼šåŸºäºå®é™…æ˜¾ç¤ºçš„æŠ¥è­¦å…ƒç´ æ•°é‡æ›´æ–°è®¡æ•°
          const currentAlertElements = alertContainer.querySelectorAll('.alert-item');
          alertCount = currentAlertElements.length;
          if (alertCountElement) {
            alertCountElement.textContent = alertCount;
          }
          
          console.log(`ğŸ“Š å®æ—¶æŠ¥è­¦å·²æ·»åŠ ï¼Œå½“å‰æ˜¾ç¤º ${alertCount} æ¡æŠ¥è­¦`);
          
          // æ’­æ”¾å£°éŸ³æç¤º
          playAlertSound();
        }

        // åˆ›å»ºæŠ¥è­¦å…ƒç´ 
        function createAlertElement(alert) {
          const alertDiv = document.createElement('div');
          alertDiv.className = 'alert-item';
          alertDiv.dataset.alertId = alert.alert_id;
          alertDiv.dataset.cameraId = alert.camera_id;
          alertDiv.dataset.alertType = alert.alert_type;
          alertDiv.dataset.alertStatus = alert.status || 'å¾…å¤„ç†';
          
          // è®¾ç½®æŠ¥è­¦ç±»å‹æ ·å¼
          alertDiv.classList.add(`alert-type-${alert.alert_type}`);
          
          // æ ¼å¼åŒ–æ—¶é—´
          const alertTime = new Date(alert.alert_time);
          const formattedTime = alertTime.toLocaleString('zh-CN');
          
          // è·å–æŠ¥è­¦ç±»å‹æ˜¾ç¤ºæ–‡æœ¬
          const alertTypeText = ALERT_TYPES[alert.alert_type] || alert.alert_type;
          
          // è·å–çŠ¶æ€ä¿¡æ¯
          const status = alert.status || 1;
          const statusDisplay = alert.status_display || getStatusInfo(alert.status).display;
          const statusInfo = getStatusInfo(alert.status);
          
          // ğŸ†• æ ¼å¼åŒ–å¤„ç†æ—¶é—´
          let processedTimeHtml = '';
          if (alert.processed_at) {
            const processedTime = new Date(alert.processed_at);
            processedTimeHtml = `<p><strong>å¤„ç†æ—¶é—´:</strong> ${processedTime.toLocaleString('zh-CN')}</p>`;
          }
          
          // ğŸ†• å¤„ç†äººå‘˜ä¿¡æ¯
          let processedByHtml = '';
          if (alert.processed_by) {
            processedByHtml = `<p><strong>å¤„ç†äººå‘˜:</strong> ${alert.processed_by}</p>`;
          }
          
          // ğŸ†• å¤„ç†å¤‡æ³¨
          let processingNotesHtml = '';
          if (alert.processing_notes) {
            processingNotesHtml = `<p><strong>å¤„ç†å¤‡æ³¨:</strong> ${alert.processing_notes}</p>`;
          }
          
          // çŠ¶æ€æ“ä½œæŒ‰é’®
          let statusActionsHtml = '';
          const statusValue = alert.status;
          
          if (statusValue === 1) {
            statusActionsHtml = `
              <div class="status-actions">
                <button class="status-btn status-btn-process" onclick="updateAlertStatus(${alert.alert_id}, 2)">
                  ğŸ”„ å¼€å§‹å¤„ç†
                </button>
                                  <button class="status-btn status-btn-resolve" onclick="updateAlertStatus(${alert.alert_id}, 3)">
                    âœ… æ ‡è®°å·²å¤„ç†
                  </button>
                  <button class="status-btn status-btn-archive" onclick="updateAlertStatus(${alert.alert_id}, 4)">
                    ğŸ“‚ å½’æ¡£
                  </button>
                  <button class="status-btn status-btn-false-alarm" onclick="updateAlertStatus(${alert.alert_id}, 5)">
                    âŒ è¯¯æŠ¥
                  </button>
              </div>
            `;
          } else if (statusValue === 2) {
            statusActionsHtml = `
              <div class="status-actions">
                <button class="status-btn status-btn-resolve" onclick="updateAlertStatus(${alert.alert_id}, 3)">
                  âœ… å®Œæˆå¤„ç†
                </button>
                <button class="status-btn status-btn-archive" onclick="updateAlertStatus(${alert.alert_id}, 4)">
                  ğŸ“‚ å½’æ¡£
                </button>
                <button class="status-btn status-btn-false-alarm" onclick="updateAlertStatus(${alert.alert_id}, 5)">
                  âŒ è¯¯æŠ¥
                </button>
              </div>
            `;
          }
          
          // ğŸ†• å¤„ç†æ£€æµ‹ç»“æœæ•°æ®
          let detectionsHtml = '';
          if (alert.result && Array.isArray(alert.result) && alert.result.length > 0) {
            detectionsHtml = `
              <div class="detection-results">
                <h4>ğŸ¯ æ£€æµ‹ç»“æœ (${alert.result.length}ä¸ªå¯¹è±¡)</h4>
                <div class="detection-list">
                  ${alert.result.map(detection => `
                    <div class="detection-item">
                      <span class="detection-name">${detection.name}</span>
                      <span class="detection-score">${(detection.score * 100).toFixed(1)}%</span>
                      <span class="detection-location">ä½ç½®: (${detection.location?.left || 0}, ${detection.location?.top || 0}) å°ºå¯¸: ${detection.location?.width || 0}Ã—${detection.location?.height || 0}</span>
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
          }

          // ğŸ†• å¤„ç†ç”µå­å›´æ æ•°æ®
          let fenceHtml = '';
          if (alert.electronic_fence && typeof alert.electronic_fence === 'object') {
            const fence = alert.electronic_fence;
            const enabled = fence.enabled ? 'å¯ç”¨' : 'ç¦ç”¨';
            const triggerMode = fence.trigger_mode === 'inside' ? 'åŒºåŸŸå†…è§¦å‘' : 
                               fence.trigger_mode === 'outside' ? 'åŒºåŸŸå¤–è§¦å‘' : 
                               fence.trigger_mode || 'æœªçŸ¥';
            const pointsCount = fence.points ? fence.points.length : 0;
            
            fenceHtml = `
              <div class="fence-info">
                <p><strong>ğŸš§ ç”µå­å›´æ :</strong> ${enabled} | ${triggerMode} | ${pointsCount}ä¸ªåŒºåŸŸ</p>
              </div>
            `;
          }

          // æ„å»ºHTMLå†…å®¹
          alertDiv.innerHTML = `
            <div class="alert-header">
              <span class="alert-type">${alertTypeText}</span>
              <div style="display: flex; align-items: center; gap: 10px;">
                <span class="status-badge ${statusInfo.class}">
                  ${statusInfo.icon} ${statusDisplay}
                </span>
                <span class="alert-time">${formattedTime}</span>
              </div>
            </div>
            <div class="alert-body">
              <div class="alert-info">
                <p><strong>ID:</strong> ${alert.alert_id || 'æœªçŸ¥'}</p>
                <p><strong>æŠ¥è­¦åç§°:</strong> ${alert.alert_name || 'æœªçŸ¥'}</p>
                <p><strong>æŠ¥è­¦æè¿°:</strong> ${alert.alert_description || 'æ— æè¿°'}</p>
                <p><strong>æ‘„åƒå¤´:</strong> ${alert.camera_name || alert.camera_id}</p>
                <p><strong>ä½ç½®:</strong> ${alert.location || 'æœªçŸ¥'}</p>
                <p><strong>æŠ¥è­¦ç­‰çº§:</strong> ${alert.alert_level || 1}</p>
                <p><strong>ä»»åŠ¡ID:</strong> ${alert.task_id || 'æœªçŸ¥'}</p>
                <p><strong>æŠ€èƒ½ID:</strong> ${alert.skill_class_id || 'æœªçŸ¥'}</p>
                <p><strong>æŠ€èƒ½åç§°:</strong> ${alert.skill_name_zh || 'æœªçŸ¥'}</p>
                ${fenceHtml}
                ${detectionsHtml}
                ${processedTimeHtml}
                ${processedByHtml}
                ${processingNotesHtml}
              </div>
              <div class="alert-image">
                <img src="${alert.minio_frame_url || '/static/img/no-image.png'}" alt="æŠ¥è­¦æˆªå›¾" onerror="this.src='/static/img/no-image.png'">
              </div>
            </div>
            <div class="alert-footer">
              <a href="${alert.minio_video_url || '#'}" target="_blank" class="alert-video-link">æŸ¥çœ‹è§†é¢‘</a>
              ${statusActionsHtml}
              <button class="alert-dismiss" onclick="dismissAlert(this.parentNode.parentNode)">å¿½ç•¥æ˜¾ç¤º</button>
            </div>
          `;
          
          return alertDiv;
        }

        // æ’­æ”¾æŠ¥è­¦å£°éŸ³
        function playAlertSound() {
          const audio = document.getElementById('alert-sound');
          if (audio) {
            audio.play().catch(error => {
              // å¿½ç•¥ç”¨æˆ·äº¤äº’é™åˆ¶å¯¼è‡´çš„é”™è¯¯
              console.log('æ— æ³•æ’­æ”¾å£°éŸ³:', error);
            });
          }
        }

        // å¿½ç•¥æŠ¥è­¦
        function dismissAlert(alertElement) {
          if (alertElement && alertElement.parentNode) {
            alertElement.parentNode.removeChild(alertElement);
            
            // ğŸ”§ ä¿®å¤ï¼šç§»é™¤æŠ¥è­¦åæ›´æ–°è®¡æ•°
            const currentAlertElements = alertContainer.querySelectorAll('.alert-item');
            alertCount = currentAlertElements.length;
            if (alertCountElement) {
              alertCountElement.textContent = alertCount;
            }
            
            console.log(`ğŸ“Š æŠ¥è­¦å·²å¿½ç•¥ï¼Œå½“å‰æ˜¾ç¤º ${alertCount} æ¡æŠ¥è­¦`);
            
            // å¦‚æœæ²¡æœ‰æŠ¥è­¦äº†ï¼Œæ˜¾ç¤ºæç¤º
            if (alertCount === 0) {
              alertContainer.innerHTML = '<div class="no-alerts"><p>æš‚æ— æŠ¥è­¦æ•°æ®</p></div>';
            }
          }
        }

        // è¿‡æ»¤æŠ¥è­¦
        function filterAlerts() {
          const cameraId = cameraFilter ? cameraFilter.value : '';
          const alertType = alertTypeFilter ? alertTypeFilter.value : '';
          
          // éå†æ‰€æœ‰æŠ¥è­¦å…ƒç´ 
          const alerts = alertContainer.getElementsByClassName('alert-item');
          for (let i = 0; i < alerts.length; i++) {
            const alert = alerts[i];
            let visible = true;
            
            // æŒ‰æ‘„åƒå¤´è¿‡æ»¤
            if (cameraId && alert.dataset.cameraId !== cameraId) {
              visible = false;
            }
            
            // æŒ‰æŠ¥è­¦ç±»å‹è¿‡æ»¤
            if (alertType && alert.dataset.alertType !== alertType) {
              visible = false;
            }
            
            // è®¾ç½®å¯è§æ€§
            alert.style.display = visible ? 'block' : 'none';
          }
        }

        // åŠ è½½å†å²æŠ¥è­¦æ•°æ®
        async function loadHistoricalAlerts() {
          try {
            showStatusMessage('æ­£åœ¨åŠ è½½å†å²æŠ¥è­¦...', 'info');
            
            const response = await fetch('/api/v1/alerts/real-time?limit=20');
            if (!response.ok) {
              throw new Error('è·å–å†å²æŠ¥è­¦å¤±è´¥');
            }
            
            const data = await response.json();
            const alerts = data.alerts || [];
            
            console.log('ğŸ“Š åŠ è½½æŠ¥è­¦æ•°æ®:', {
              loaded_alerts: alerts.length,
              total_in_db: data.total,
              pages: data.pages,
              current_page: data.page
            });
            
            // æ¸…ç©ºå®¹å™¨
            if (alertContainer) {
              alertContainer.innerHTML = '';
            }
            
            if (alerts.length === 0) {
              alertContainer.innerHTML = '<div class="no-alerts"><p>æš‚æ— æŠ¥è­¦æ•°æ®</p></div>';
              // ğŸ”§ ä¿®å¤ï¼šæ²¡æœ‰æ•°æ®æ—¶ï¼Œæ˜¾ç¤ºè®°å½•æ•°ä¸º0
              alertCount = 0;
              if (alertCountElement) {
                alertCountElement.textContent = 0;
              }
              showStatusMessage('æš‚æ— æŠ¥è­¦æ•°æ®', 'info');
            } else {
              // æ·»åŠ æŠ¥è­¦
              alerts.forEach(alert => {
                const alertElement = createAlertElement(alert);
                alertContainer.appendChild(alertElement);
              });
              
              // ğŸ”§ ä¿®å¤ï¼šæ˜¾ç¤ºå½“å‰é¡µé¢åŠ è½½çš„è®°å½•æ•°ï¼Œè€Œä¸æ˜¯æ•°æ®åº“æ€»æ•°
              alertCount = alerts.length;
              if (alertCountElement) {
                alertCountElement.textContent = alerts.length;
              }
              
              // ğŸ”§ ä¿®å¤ï¼šçŠ¶æ€æ¶ˆæ¯æ˜¾ç¤ºæ›´è¯¦ç»†çš„ä¿¡æ¯
              const totalRecords = data.total || alerts.length;
              const statusMsg = totalRecords > alerts.length 
                ? `åŠ è½½å®Œæˆï¼Œæ˜¾ç¤ºæœ€æ–° ${alerts.length} æ¡è®°å½•ï¼ˆæ•°æ®åº“å…± ${totalRecords} æ¡ï¼‰`
                : `åŠ è½½å®Œæˆï¼Œå…± ${alerts.length} æ¡è®°å½•`;
              
              showStatusMessage(statusMsg, 'success');
              
              console.log(`âœ… æŠ¥è­¦æ•°æ®åŠ è½½å®Œæˆ: æ˜¾ç¤º${alerts.length}æ¡ï¼Œæ€»è®¡${totalRecords}æ¡`);
            }
            
          } catch (error) {
            console.error('åŠ è½½å†å²æŠ¥è­¦å¤±è´¥:', error);
            showStatusMessage('åŠ è½½å¤±è´¥: ' + error.message, 'error');
            
            // ğŸ”§ ä¿®å¤ï¼šå‡ºé”™æ—¶é‡ç½®è®¡æ•°å™¨
            alertCount = 0;
            if (alertCountElement) {
              alertCountElement.textContent = 0;
            }
          }
        }

        // ç”Ÿæˆæµ‹è¯•æŠ¥è­¦ï¼ˆä½¿ç”¨AIä»»åŠ¡æ‰§è¡Œå™¨ï¼‰
        async function sendTestAlert() {
          const button = document.getElementById('send-test-alert');
          const originalText = button.innerHTML;
          
          try {
            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            button.disabled = true;
            button.innerHTML = '<span class="loading"></span>ç”Ÿæˆä¸­...';
            
            showStatusMessage('æ­£åœ¨ä½¿ç”¨AIä»»åŠ¡æ‰§è¡Œå™¨ç”Ÿæˆæµ‹è¯•æŠ¥è­¦...', 'info');
            console.log('ç”Ÿæˆæµ‹è¯•æŠ¥è­¦è¯·æ±‚, è¿æ¥ID:', connectionId);
            
            const response = await fetch('/api/v1/alerts/test', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              }
            });
            
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            console.log('æµ‹è¯•æŠ¥è­¦ç”ŸæˆæˆåŠŸ:', result);
            
            // æ ¹æ®æ–°æ¥å£çš„å“åº”æ ¼å¼æä¾›æ›´è¯¦ç»†çš„åé¦ˆ
            const alertId = result.alert_id || 'unknown';
            const method = result.method || 'unknown';
            const isAIExecutor = method.includes('ai_task_executor');
            
            if (isAIExecutor) {
              showStatusMessage(`âœ… æµ‹è¯•æŠ¥è­¦ç”ŸæˆæˆåŠŸï¼ä½¿ç”¨AIä»»åŠ¡æ‰§è¡Œå™¨ (ID: ${alertId})`, 'success');
              console.log(`ğŸ¯ è°ƒç”¨æ–¹æ³•: ${method}`);
            } else {
              showStatusMessage(`âœ… æµ‹è¯•æŠ¥è­¦å‘é€æˆåŠŸï¼(ID: ${alertId})`, 'success');
            }
            
            // å¦‚æœå“åº”åŒ…å«æ–¹æ³•ä¿¡æ¯ï¼Œè®°å½•åˆ°æ§åˆ¶å°
            if (result.method) {
              console.log(`ğŸ“‹ æ‰§è¡Œæ–¹æ³•: ${result.method}`);
            }
            
          } catch (error) {
            console.error('ç”Ÿæˆæµ‹è¯•æŠ¥è­¦å¤±è´¥:', error);
            showStatusMessage('âŒ ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
          } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            button.disabled = false;
            button.innerHTML = originalText;
          }
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatusMessage(message, type) {
          if (statusMessage) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;
            statusMessage.style.display = 'inline-block';
            
            // 3ç§’åè‡ªåŠ¨éšè—æˆåŠŸæ¶ˆæ¯
            if (type === 'success') {
              setTimeout(() => {
                statusMessage.style.display = 'none';
              }, 3000);
            }
          }
        }

        // æ£€æŸ¥SSEè¿æ¥çŠ¶æ€
        async function checkSSEStatus() {
          try {
            showStatusMessage('æ­£åœ¨æ£€æŸ¥SSEè¿æ¥çŠ¶æ€...', 'info');
            
            // æ£€æŸ¥æœåŠ¡å™¨ç«¯çš„è¿æ¥ç»Ÿè®¡
            const response = await fetch('/api/v1/alerts/sse/status');
            if (!response.ok) {
              throw new Error('è·å–æœåŠ¡å™¨SSEçŠ¶æ€å¤±è´¥');
            }
            
            const data = await response.json();
            console.log('æœåŠ¡å™¨SSEçŠ¶æ€:', data);
            
            // æ£€æŸ¥å®¢æˆ·ç«¯è¿æ¥çŠ¶æ€
            const clientStatus = eventSource ? 
              (eventSource.readyState === EventSource.OPEN ? 'å·²è¿æ¥' : 
               eventSource.readyState === EventSource.CONNECTING ? 'è¿æ¥ä¸­' : 'å·²æ–­å¼€') : 'æœªè¿æ¥';
            
            // æ„å»ºè¯¦ç»†çŠ¶æ€ä¿¡æ¯
            const statusInfo = {
              client: {
                status: clientStatus,
                connectionId: connectionId,
                readyState: eventSource ? eventSource.readyState : null,
                isConnecting: isConnecting,
                hasReconnectTimeout: !!reconnectTimeout
              },
              server: data,
              stats: connectionStats,
              page: {
                hidden: document.hidden,
                url: window.location.href,
                userAgent: navigator.userAgent.substring(0, 100)
              }
            };
            
            console.log('ğŸ” å®Œæ•´è¿æ¥çŠ¶æ€:', statusInfo);
            
            const statusText = `ğŸ–¥ï¸ å®¢æˆ·ç«¯: ${clientStatus} | ğŸŒ æœåŠ¡å™¨: ${data.connected_clients} ä¸ªè¿æ¥ | ğŸ“Š æ€»è¿æ¥: ${connectionStats.totalConnections} æ¬¡`;
            showStatusMessage(statusText, 'success');
            
            // å¦‚æœè¿æ¥å¼‚å¸¸é¢‘ç¹ï¼Œç»™å‡ºè­¦å‘Š
            if (connectionStats.totalConnections > 10) {
              console.warn('âš ï¸ æ£€æµ‹åˆ°å¼‚å¸¸é¢‘ç¹çš„è¿æ¥ï¼è¿æ¥ç»Ÿè®¡:', connectionStats);
              showStatusMessage(`âš ï¸ è­¦å‘Šï¼šæ£€æµ‹åˆ° ${connectionStats.totalConnections} æ¬¡è¿æ¥ï¼Œå¯èƒ½å­˜åœ¨é—®é¢˜`, 'error');
            }
            
          } catch (error) {
            console.error('æ£€æŸ¥SSEè¿æ¥çŠ¶æ€å¤±è´¥:', error);
            showStatusMessage('âŒ æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
          }
        }

        // åº”ç”¨è¿‡æ»¤å™¨
        async function applyFilters() {
          try {
            showStatusMessage('æ­£åœ¨åº”ç”¨è¿‡æ»¤å™¨...', 'info');
            
            // è·å–è¿‡æ»¤æ¡ä»¶
            const status = document.getElementById('status-filter').value;
            const alertType = document.getElementById('alert-type-filter').value;
            const cameraName = document.getElementById('camera-filter').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            // æ„å»ºæŸ¥è¯¢å‚æ•°
            const params = new URLSearchParams();
            if (status) params.append('status', status);
            if (alertType) params.append('alert_type', alertType);
            if (cameraName) params.append('camera_name', cameraName);
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            params.append('limit', '50'); // é™åˆ¶è¿”å›æ•°é‡
            
            console.log('ğŸ” åº”ç”¨è¿‡æ»¤å™¨:', Object.fromEntries(params));
            
            const response = await fetch(`/api/v1/alerts/real-time?${params}`);
            if (!response.ok) {
              throw new Error('è·å–è¿‡æ»¤ç»“æœå¤±è´¥');
            }
            
            const data = await response.json();
            const alerts = data.alerts || [];
            
            // æ¸…ç©ºå®¹å™¨å¹¶æ˜¾ç¤ºç»“æœ
            if (alertContainer) {
              alertContainer.innerHTML = '';
            }
            
            if (alerts.length === 0) {
              alertContainer.innerHTML = '<div class="no-alerts"><p>æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æŠ¥è­¦æ•°æ®</p></div>';
              alertCount = 0;
            } else {
              alerts.forEach(alert => {
                const alertElement = createAlertElement(alert);
                alertContainer.appendChild(alertElement);
              });
              alertCount = alerts.length;
            }
            
            if (alertCountElement) {
              alertCountElement.textContent = alertCount;
            }
            
            const summary = data.summary || {};
            showStatusMessage(`è¿‡æ»¤å®Œæˆ: æ˜¾ç¤º ${alerts.length} æ¡è®°å½•ï¼Œå…± ${summary.total_count || 0} æ¡ç¬¦åˆæ¡ä»¶`, 'success');
            
          } catch (error) {
            console.error('åº”ç”¨è¿‡æ»¤å™¨å¤±è´¥:', error);
            showStatusMessage('è¿‡æ»¤å¤±è´¥: ' + error.message, 'error');
          }
        }
        
        // ğŸ†• æ¸…ç©ºè¿‡æ»¤å™¨
        function clearFilters() {
          document.getElementById('status-filter').value = '';
          document.getElementById('alert-type-filter').value = '';
          document.getElementById('camera-filter').value = '';
          document.getElementById('start-date').value = '';
          document.getElementById('end-date').value = '';
          
          // é‡æ–°åŠ è½½å†å²æ•°æ®
          loadHistoricalAlerts();
          showStatusMessage('è¿‡æ»¤å™¨å·²æ¸…ç©º', 'info');
        }
        
        // æ›´æ–°æŠ¥è­¦çŠ¶æ€
        async function updateAlertStatus(alertId, newStatus) {
          try {
            // å°†æ•´æ•°çŠ¶æ€è½¬æ¢ä¸ºæ˜¾ç¤ºåç§°ç”¨äºæç¤º
            const statusDisplayMap = {
              1: 'å¾…å¤„ç†', 2: 'å¤„ç†ä¸­', 3: 'å·²å¤„ç†', 4: 'å·²å¿½ç•¥', 5: 'å·²è¿‡æœŸ'
            };
            const statusDisplay = statusDisplayMap[newStatus];
            
            showStatusMessage(`æ­£åœ¨æ›´æ–°æŠ¥è­¦ ${alertId} çŠ¶æ€ä¸º ${statusDisplay}...`, 'info');
            
            const response = await fetch(`/api/v1/alerts/${alertId}/status`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                status: newStatus,
                processed_by: 'å‰ç«¯ç”¨æˆ·', // å¯ä»¥ä»ç”¨æˆ·ä¿¡æ¯è·å–
                processing_notes: `é€šè¿‡å‰ç«¯ç•Œé¢æ›´æ–°çŠ¶æ€ä¸º: ${statusDisplay}`
              })
            });
            
            if (!response.ok) {
              throw new Error('æ›´æ–°çŠ¶æ€å¤±è´¥');
            }
            
            const updatedAlert = await response.json();
            console.log('âœ… çŠ¶æ€æ›´æ–°æˆåŠŸ:', updatedAlert);
            
            // æ›´æ–°é¡µé¢ä¸Šçš„æŠ¥è­¦å…ƒç´ 
            const alertElement = document.querySelector(`[data-alert-id="${alertId}"]`);
            if (alertElement) {
              // é‡æ–°åˆ›å»ºå…ƒç´ ä»¥åæ˜ æ–°çŠ¶æ€
              const newAlertElement = createAlertElement(updatedAlert);
              alertElement.parentNode.replaceChild(newAlertElement, alertElement);
            }
            
            showStatusMessage(`æŠ¥è­¦ ${alertId} çŠ¶æ€å·²æ›´æ–°ä¸º ${statusDisplay}`, 'success');
            
          } catch (error) {
            console.error('æ›´æ–°çŠ¶æ€å¤±è´¥:', error);
            showStatusMessage('æ›´æ–°çŠ¶æ€å¤±è´¥: ' + error.message, 'error');
          }
        }
        
        // ğŸ†• æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
        async function showStatistics() {
          try {
            showStatusMessage('æ­£åœ¨è·å–ç»Ÿè®¡ä¿¡æ¯...', 'info');
            
            const response = await fetch('/api/v1/alerts/statistics');
            if (!response.ok) {
              throw new Error('è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥');
            }
            
            const stats = await response.json();
            console.log('ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:', stats);
            
            // æ„å»ºç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤º
            const statusDist = stats.status_distribution || {};
            const typeDist = stats.type_distribution || {};
            const levelDist = stats.level_distribution || {};
            
            const statsHtml = `
              <div style="padding: 20px; background: white; border-radius: 6px; margin: 10px 0; border: 1px solid #d9d9d9;">
                <h3>ğŸ“Š æŠ¥è­¦ç»Ÿè®¡ä¿¡æ¯</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                  <div>
                    <h4>ğŸ“ˆ çŠ¶æ€åˆ†å¸ƒ</h4>
                    <ul style="list-style: none; padding: 0;">
                      <li>â³ å¾…å¤„ç†: ${statusDist['å¾…å¤„ç†'] || 0} æ¡</li>
                      <li>ğŸ”„ å¤„ç†ä¸­: ${statusDist['å¤„ç†ä¸­'] || 0} æ¡</li>
                      <li>âœ… å·²å¤„ç†: ${statusDist['å·²å¤„ç†'] || 0} æ¡</li>
                      <li>ğŸš« å·²å¿½ç•¥: ${statusDist['å·²å¿½ç•¥'] || 0} æ¡</li>
                      <li>â° å·²è¿‡æœŸ: ${statusDist['å·²è¿‡æœŸ'] || 0} æ¡</li>
                    </ul>
                  </div>
                  <div>
                    <h4>ğŸ·ï¸ ç±»å‹åˆ†å¸ƒ</h4>
                    <ul style="list-style: none; padding: 0;">
                      ${Object.entries(typeDist).map(([type, count]) => 
                        `<li>${ALERT_TYPES[type] || type}: ${count} æ¡</li>`
                      ).join('')}
                    </ul>
                  </div>
                  <div>
                    <h4>âš¡ ç­‰çº§åˆ†å¸ƒ</h4>
                    <ul style="list-style: none; padding: 0;">
                      ${Object.entries(levelDist).map(([level, count]) => 
                        `<li>ç­‰çº§ ${level}: ${count} æ¡</li>`
                      ).join('')}
                    </ul>
                  </div>
                </div>
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #f0f0f0;">
                  <strong>ğŸ“Š æ€»è®¡: ${stats.total_alerts || 0} æ¡æŠ¥è­¦</strong>
                </div>
                <button onclick="this.parentElement.remove()" style="margin-top: 10px; padding: 5px 10px; background: #f5f5f5; border: 1px solid #d9d9d9; border-radius: 3px; cursor: pointer;">å…³é—­</button>
              </div>
            `;
            
            // åœ¨æŠ¥è­¦å®¹å™¨å‰æ’å…¥ç»Ÿè®¡ä¿¡æ¯
            const statsDiv = document.createElement('div');
            statsDiv.innerHTML = statsHtml;
            alertContainer.parentNode.insertBefore(statsDiv, alertContainer);
            
            showStatusMessage('ç»Ÿè®¡ä¿¡æ¯å·²æ˜¾ç¤º', 'success');
            
          } catch (error) {
            console.error('è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
            showStatusMessage('è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: ' + error.message, 'error');
          }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
          console.log('ğŸš€ æŠ¥è­¦ç›‘æ§é¡µé¢åˆå§‹åŒ–å¼€å§‹');
          
          // è·å–DOMå…ƒç´ 
          alertContainer = document.getElementById('alert-container');
          connectionStatus = document.getElementById('connection-status');
          alertCountElement = document.getElementById('alert-count');
          connectionIdElement = document.getElementById('connection-id');
          cameraFilter = document.getElementById('camera-filter');
          alertTypeFilter = document.getElementById('alert-type-filter');
          statusMessage = document.getElementById('status-message');
          
          // ğŸ†• è·å–æ–°çš„è¿‡æ»¤å™¨å…ƒç´ 
          statusFilter = document.getElementById('status-filter');
          startDateFilter = document.getElementById('start-date');
          endDateFilter = document.getElementById('end-date');
          cameraNameFilter = document.getElementById('camera-filter');
          
          // åˆå§‹åŒ–è¿‡æ»¤å™¨äº‹ä»¶
          if (cameraFilter) {
            cameraFilter.addEventListener('change', filterAlerts);
          }
          
          if (alertTypeFilter) {
            alertTypeFilter.addEventListener('change', filterAlerts);
          }
          
          // è¿æ¥åˆ°SSE
          connectSSE();
          
          // åŠ è½½å†å²æŠ¥è­¦æ•°æ®
          loadHistoricalAlerts();
          
          // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
          const testButton = document.getElementById('send-test-alert');
          if (testButton) {
            testButton.addEventListener('click', sendTestAlert);
          }
          
          const refreshButton = document.getElementById('refresh-alerts');
          if (refreshButton) {
            refreshButton.addEventListener('click', function() {
              console.log('ğŸ”„ æ‰‹åŠ¨åˆ·æ–°æŠ¥è­¦æ•°æ®');
              loadHistoricalAlerts();
            });
          }
          
          const statusButton = document.getElementById('check-sse-status');
          if (statusButton) {
            statusButton.addEventListener('click', function() {
              checkConnectionStatus();
            });
          }
          
          // ğŸ†• æ·»åŠ ç»Ÿè®¡ä¿¡æ¯æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
          const statisticsButton = document.getElementById('show-statistics');
          if (statisticsButton) {
            statisticsButton.addEventListener('click', showStatistics);
          }
          
          console.log('âœ… æŠ¥è­¦ç›‘æ§é¡µé¢åˆå§‹åŒ–å®Œæˆ');
        });
    </script>
</body>
</html> 