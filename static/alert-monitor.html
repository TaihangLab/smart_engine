<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘ç›‘æ§æŠ¥è­¦ç³»ç»Ÿ</title>
    <style>
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
        }
        
        .header {
            background-color: #262f3e;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.5rem;
        }
        
        .status-bar {
            background-color: #f9f9f9;
            padding: 10px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .connected {
            color: #52c41a;
        }
        
        .disconnected {
            color: #f5222d;
        }
        
        .alert-count {
            background-color: #1890ff;
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 0.8rem;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .filters select {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #d9d9d9;
        }
        
        .content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .alert-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .alert-item {
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            border-left: 4px solid #ff4d4f;
            transition: all 0.3s ease;
        }
        
        .alert-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        .alert-header {
            display: flex;
            justify-content: space-between;
            padding: 12px 15px;
            background-color: #fafafa;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .alert-type {
            font-weight: bold;
            color: #ff4d4f;
        }
        
        .alert-time {
            color: #888;
            font-size: 0.9rem;
        }
        
        .alert-body {
            padding: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .alert-info {
            flex: 1;
            min-width: 250px;
        }
        
        .alert-info p {
            margin: 5px 0;
            line-height: 1.5;
        }
        
        .alert-image {
            flex: 1;
            min-width: 250px;
            max-width: 500px;
        }
        
        .alert-image img {
            width: 100%;
            border-radius: 4px;
            object-fit: cover;
        }
        
        .alert-footer {
            padding: 10px 15px;
            border-top: 1px solid #f0f0f0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .alert-video-link {
            color: #1890ff;
            text-decoration: none;
            padding: 5px 10px;
        }
        
        .alert-video-link:hover {
            text-decoration: underline;
        }
        
        .alert-dismiss {
            background-color: #f0f0f0;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
        }
        
        .alert-dismiss:hover {
            background-color: #e0e0e0;
        }
        
        .no-alerts {
            text-align: center;
            padding: 50px;
            color: #999;
        }
        
        /* æŠ¥è­¦ç±»å‹æ ·å¼ */
        .alert-type-no_helmet {
            border-left-color: #ff4d4f;
        }
        
        .alert-type-intrusion {
            border-left-color: #ff7a45;
        }
        
        .alert-type-fire {
            border-left-color: #ff4d4f;
        }
        
        .alert-type-smoke {
            border-left-color: #ffa940;
        }
        
        .alert-type-loitering {
            border-left-color: #faad14;
        }
        
        .alert-type-abnormal_behavior {
            border-left-color: #faad14;
        }
        
        .alert-type-test_alert {
            border-left-color: #1890ff;
        }
        
        .actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .test-button {
            background-color: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .test-button:hover {
            background-color: #096dd9;
        }
        
        .test-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .status-message {
            padding: 8px 12px;
            border-radius: 4px;
            margin-left: 10px;
            display: none;
        }
        
        .status-message.success {
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }
        
        .status-message.error {
            background-color: #fff1f0;
            border: 1px solid #ffa39e;
            color: #ff4d4f;
        }
        
        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
            margin-right: 5px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media screen and (max-width: 768px) {
            .status-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .filters {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <!-- æŠ¥è­¦éŸ³æ•ˆ -->
    <audio id="alert-sound" src="/static/sound/alert.mp3" preload="auto"></audio>
    
    <!-- é¡µé¢å¤´éƒ¨ -->
    <header class="header">
        <h1>è§†é¢‘ç›‘æ§æŠ¥è­¦ç³»ç»Ÿ</h1>
    </header>
    
    <!-- çŠ¶æ€æ  -->
    <div class="status-bar">
        <div class="status-item">
            <span>SSEè¿æ¥:</span>
            <span id="connection-status" class="disconnected">æœªè¿æ¥</span>
        </div>
        
        <div class="status-item">
            <span>æŠ¥è­¦æ•°é‡:</span>
            <span id="alert-count" class="alert-count">0</span>
        </div>
        
        <div class="status-item">
            <span>è¿æ¥ID:</span>
            <span id="connection-id" class="alert-count">-</span>
        </div>
        
        <div class="filters">
            <select id="camera-filter">
                <option value="">æ‰€æœ‰æ‘„åƒå¤´</option>
                <option value="camera_01">æ‘„åƒå¤´ 1</option>
                <option value="camera_02">æ‘„åƒå¤´ 2</option>
                <option value="camera_03">æ‘„åƒå¤´ 3</option>
            </select>
            
            <select id="alert-type-filter">
                <option value="">æ‰€æœ‰æŠ¥è­¦ç±»å‹</option>
                <option value="no_helmet">æœªä½©æˆ´å®‰å…¨å¸½</option>
                <option value="intrusion">å…¥ä¾µè­¦å‘Š</option>
                <option value="fire">ç«ç¾è­¦å‘Š</option>
                <option value="smoke">çƒŸé›¾è­¦å‘Š</option>
                <option value="loitering">å¾˜å¾Šè¡Œä¸º</option>
                <option value="abnormal_behavior">å¼‚å¸¸è¡Œä¸º</option>
            </select>
        </div>
    </div>
    
    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="content">
        <div class="actions">
            <div>
                <button id="send-test-alert" class="test-button">ğŸš€ å‘é€æµ‹è¯•æŠ¥è­¦</button>
                <span id="status-message" class="status-message"></span>
            </div>
            <div>
                <button id="refresh-alerts" class="test-button" style="background-color: #52c41a;">ğŸ”„ åˆ·æ–°æŠ¥è­¦</button>
                <button id="check-sse-status" class="test-button" style="background-color: #1890ff;">ğŸ“Š è¿æ¥çŠ¶æ€</button>
            </div>
        </div>
        
        <div id="alert-container" class="alert-container">
            <div class="no-alerts">
                <p>ç­‰å¾…æŠ¥è­¦æ•°æ®...</p>
            </div>
        </div>
    </div>
    
    <script>
        // æŠ¥è­¦ç±»å‹å’Œå¯¹åº”çš„æ˜¾ç¤ºæ–‡æœ¬
        const ALERT_TYPES = {
          'no_helmet': 'æœªä½©æˆ´å®‰å…¨å¸½',
          'intrusion': 'å…¥ä¾µè­¦å‘Š',
          'fire': 'ç«ç¾è­¦å‘Š',
          'smoke': 'çƒŸé›¾è­¦å‘Š',
          'loitering': 'å¾˜å¾Šè¡Œä¸º',
          'abnormal_behavior': 'å¼‚å¸¸è¡Œä¸º',
          'test_alert': 'æµ‹è¯•æŠ¥è­¦'
        };

        // å…¨å±€å˜é‡
        let eventSource = null;
        let alertCount = 0;
        let reconnectTimeout = null;
        let connectionId = null;
        let isConnecting = false;
        const MAX_ALERTS = 100; // æœ€å¤šæ˜¾ç¤ºçš„æŠ¥è­¦æ•°é‡
        
        // æ·»åŠ è¿æ¥ç»Ÿè®¡
        let connectionStats = {
          totalConnections: 0,
          totalReconnects: 0,
          lastConnectTime: null,
          lastDisconnectTime: null,
          connectionHistory: []
        };

        // DOMå…ƒç´ 
        let alertContainer;
        let connectionStatus;
        let alertCountElement;
        let connectionIdElement;
        let cameraFilter;
        let alertTypeFilter;
        let statusMessage;

        // ç”Ÿæˆå”¯ä¸€è¿æ¥ID
        function generateConnectionId() {
            return 'conn_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // åˆå§‹åŒ–å‡½æ•°
        function initAlertMonitor() {
          console.log('åˆå§‹åŒ–æŠ¥è­¦ç›‘æ§ç³»ç»Ÿ...');
          
          // ç”Ÿæˆè¿æ¥ID
          connectionId = generateConnectionId();
          
          // è·å–DOMå…ƒç´ 
          alertContainer = document.getElementById('alert-container');
          connectionStatus = document.getElementById('connection-status');
          alertCountElement = document.getElementById('alert-count');
          connectionIdElement = document.getElementById('connection-id');
          cameraFilter = document.getElementById('camera-filter');
          alertTypeFilter = document.getElementById('alert-type-filter');
          statusMessage = document.getElementById('status-message');
          
          // æ˜¾ç¤ºè¿æ¥ID
          if (connectionIdElement) {
            connectionIdElement.textContent = connectionId.substr(-8);
          }
          
          // åˆå§‹åŒ–è¿‡æ»¤å™¨äº‹ä»¶
          if (cameraFilter) {
            cameraFilter.addEventListener('change', filterAlerts);
          }
          
          if (alertTypeFilter) {
            alertTypeFilter.addEventListener('change', filterAlerts);
          }
          
          // è¿æ¥åˆ°SSE
          connectSSE();
          
          // åŠ è½½å†å²æŠ¥è­¦æ•°æ®
          loadHistoricalAlerts();
          
          // æ·»åŠ æµ‹è¯•æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
          const testButton = document.getElementById('send-test-alert');
          if (testButton) {
            testButton.addEventListener('click', sendTestAlert);
          }
          
          // æ·»åŠ åˆ·æ–°æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
          const refreshButton = document.getElementById('refresh-alerts');
          if (refreshButton) {
            refreshButton.addEventListener('click', loadHistoricalAlerts);
          }
          
          // æ·»åŠ è¿æ¥çŠ¶æ€æ£€æŸ¥æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
          const checkStatusButton = document.getElementById('check-sse-status');
          if (checkStatusButton) {
            checkStatusButton.addEventListener('click', checkSSEStatus);
          }
          
          // é¡µé¢å¸è½½æ—¶æ¸…ç†è¿æ¥
          window.addEventListener('beforeunload', function() {
            cleanupConnection();
          });
          
          // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶ç®¡ç†è¿æ¥
          document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
              console.log('é¡µé¢éšè—ï¼Œæš‚åœé‡è¿');
              // ğŸ”§ ä¼˜åŒ–ï¼šé¡µé¢éšè—æ—¶å–æ¶ˆé‡è¿è®¡æ—¶å™¨ï¼Œä½†ä¸å…³é—­è¿æ¥
              if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
                reconnectTimeout = null;
                console.log('å·²å–æ¶ˆé‡è¿è®¡æ—¶å™¨');
              }
            } else {
              console.log('é¡µé¢æ˜¾ç¤ºï¼Œæ£€æŸ¥è¿æ¥çŠ¶æ€');
              // ğŸ”§ ä¼˜åŒ–ï¼šæ›´ä¸¥æ ¼çš„è¿æ¥çŠ¶æ€æ£€æŸ¥
              if (!eventSource) {
                console.log('ğŸ”„ eventSourceä¸å­˜åœ¨ï¼Œå»ºç«‹æ–°è¿æ¥');
                connectSSE();
              } else if (eventSource.readyState === EventSource.CLOSED) {
                console.log('ğŸ”„ è¿æ¥å·²å…³é—­ï¼Œå»ºç«‹æ–°è¿æ¥');
                connectSSE();
              } else if (eventSource.readyState === EventSource.CONNECTING) {
                console.log('â³ è¿æ¥æ­£åœ¨å»ºç«‹ä¸­ï¼Œç­‰å¾…...');
              } else if (eventSource.readyState === EventSource.OPEN) {
                console.log('âœ… è¿æ¥æ­£å¸¸ï¼Œæ— éœ€é‡æ–°è¿æ¥');
              }
            }
          });
        }

        // æ¸…ç†è¿æ¥
        function cleanupConnection() {
          console.log('æ¸…ç†SSEè¿æ¥:', connectionId);
          
          if (reconnectTimeout) {
            clearTimeout(reconnectTimeout);
            reconnectTimeout = null;
          }
          
          if (eventSource) {
            eventSource.close();
            eventSource = null;
          }
          
          isConnecting = false;
        }

        // è¿æ¥åˆ°SSEæœåŠ¡å™¨
        function connectSSE() {
          // ğŸ”§ ä¼˜åŒ–ï¼šæ›´ä¸¥æ ¼çš„é‡å¤è¿æ¥æ£€æŸ¥
          if (isConnecting) {
            console.log('âš ï¸ æ­£åœ¨è¿æ¥ä¸­ï¼Œè·³è¿‡é‡å¤è¿æ¥è¯·æ±‚');
            return;
          }
          
          // ğŸ”§ ä¼˜åŒ–ï¼šæ£€æŸ¥ç°æœ‰è¿æ¥çŠ¶æ€ï¼ŒåŒ…æ‹¬CONNECTINGçŠ¶æ€
          if (eventSource) {
            if (eventSource.readyState === EventSource.OPEN) {
              console.log('âœ… SSEè¿æ¥å·²å­˜åœ¨ä¸”æ­£å¸¸ï¼Œæ— éœ€é‡æ–°è¿æ¥');
              return;
            } else if (eventSource.readyState === EventSource.CONNECTING) {
              console.log('â³ SSEè¿æ¥æ­£åœ¨å»ºç«‹ä¸­ï¼Œç­‰å¾…å®Œæˆ...');
              return;
            }
          }
          
          // æ¸…ç†æ—§è¿æ¥
          cleanupConnection();
          
          isConnecting = true;
          console.log('ğŸ”— å¼€å§‹å»ºç«‹SSEè¿æ¥:', connectionId);
          console.log('ğŸ” è°ƒç”¨æ ˆ:', new Error().stack);  // æ·»åŠ è°ƒç”¨æ ˆè·Ÿè¸ª
          
          // è®°å½•è¿æ¥ç»Ÿè®¡
          connectionStats.totalConnections++;
          connectionStats.lastConnectTime = new Date();
          connectionStats.connectionHistory.push({
            type: 'connect_attempt',
            time: new Date(),
            connectionId: connectionId
          });
          
          // ä¿æŒå†å²è®°å½•åœ¨åˆç†èŒƒå›´å†…
          if (connectionStats.connectionHistory.length > 50) {
            connectionStats.connectionHistory = connectionStats.connectionHistory.slice(-50);
          }
          
          console.log('ğŸ“Š è¿æ¥ç»Ÿè®¡:', connectionStats);
          
          // æ›´æ–°çŠ¶æ€
          updateConnectionStatus('æ­£åœ¨è¿æ¥...');
          
          // åˆ›å»ºæ–°è¿æ¥
          eventSource = new EventSource('/api/v1/alerts/stream');
          
          // è¿æ¥æ‰“å¼€äº‹ä»¶
          eventSource.addEventListener('open', function() {
            console.log('âœ… SSEè¿æ¥å·²å»ºç«‹:', connectionId);
            updateConnectionStatus('å·²è¿æ¥');
            isConnecting = false;
            
            // å–æ¶ˆé‡è¿è®¡æ—¶å™¨
            if (reconnectTimeout) {
              clearTimeout(reconnectTimeout);
              reconnectTimeout = null;
            }
          });
          
          // æ¶ˆæ¯äº‹ä»¶
          eventSource.addEventListener('message', function(event) {
            try {
              const data = JSON.parse(event.data);
              
              // å¦‚æœæ˜¯è¿æ¥æˆåŠŸæ¶ˆæ¯ï¼Œå¿½ç•¥
              if (data.event === 'connected') {
                console.log('ğŸ“¡ æ”¶åˆ°SSEè¿æ¥ç¡®è®¤æ¶ˆæ¯');
                return;
              }
              
              // å¤„ç†æŠ¥è­¦æ¶ˆæ¯
              console.log('ğŸš¨ æ”¶åˆ°SSEæŠ¥è­¦æ¶ˆæ¯:', data);
              handleAlertMessage(data);
              
            } catch (error) {
              console.error('âŒ è§£ææŠ¥è­¦æ¶ˆæ¯å¤±è´¥:', error, event.data);
            }
          });
          
          // é”™è¯¯äº‹ä»¶
          eventSource.addEventListener('error', function(event) {
            console.log('âŒ SSEè¿æ¥é”™è¯¯:', event);
            console.log('ğŸ” é”™è¯¯æ—¶è¿æ¥çŠ¶æ€:', eventSource ? eventSource.readyState : 'null');
            console.log('ğŸ” é¡µé¢å¯è§æ€§:', document.hidden ? 'éšè—' : 'å¯è§');
            
            // è®°å½•æ–­å¼€ç»Ÿè®¡
            connectionStats.lastDisconnectTime = new Date();
            connectionStats.connectionHistory.push({
              type: 'disconnect',
              time: new Date(),
              connectionId: connectionId,
              readyState: eventSource ? eventSource.readyState : null
            });
            
            updateConnectionStatus('è¿æ¥æ–­å¼€');
            isConnecting = false;
            
            // ğŸ”§ ä¼˜åŒ–ï¼šæ›´ç²¾ç¡®çš„é‡è¿æ¡ä»¶åˆ¤æ–­
            if (eventSource && eventSource.readyState === EventSource.CLOSED) {
              // åªæœ‰åœ¨é¡µé¢å¯è§ã€æ— é‡è¿è®¡æ—¶å™¨ä¸”è¿æ¥çœŸæ­£å…³é—­æ—¶æ‰é‡è¿
              if (!document.hidden && !reconnectTimeout) {
                console.log('â³ 10ç§’åå°è¯•é‡è¿...');
                connectionStats.totalReconnects++;
                reconnectTimeout = setTimeout(() => {
                  console.log('ğŸ”„ æ‰§è¡Œé‡è¿...');
                  reconnectTimeout = null;
                  // ğŸ”§ ä¼˜åŒ–ï¼šé‡è¿å‰å†æ¬¡æ£€æŸ¥è¿æ¥çŠ¶æ€
                  if (!eventSource || eventSource.readyState === EventSource.CLOSED) {
                    connectSSE();
                  } else {
                    console.log('ğŸš« è¿æ¥çŠ¶æ€å·²æ¢å¤ï¼Œå–æ¶ˆé‡è¿');
                  }
                }, 10000); // å¢åŠ é‡è¿é—´éš”åˆ°10ç§’
              } else {
                console.log('ğŸš« è·³è¿‡é‡è¿ - é¡µé¢éšè—:', document.hidden, 'æˆ–å·²æœ‰é‡è¿è®¡æ—¶å™¨:', !!reconnectTimeout);
              }
            } else {
              console.log('ğŸ” è¿æ¥çŠ¶æ€éCLOSEDï¼Œç­‰å¾…çŠ¶æ€å˜åŒ–...');
            }
          });
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
        function updateConnectionStatus(status) {
          if (connectionStatus) {
            connectionStatus.textContent = status;
            connectionStatus.className = status === 'å·²è¿æ¥' ? 'connected' : 'disconnected';
          }
        }

        // å¤„ç†æŠ¥è­¦æ¶ˆæ¯
        function handleAlertMessage(alert) {
          console.log('å¤„ç†æŠ¥è­¦æ¶ˆæ¯:', alert);
          
          // åˆ›å»ºæŠ¥è­¦å…ƒç´ 
          const alertElement = createAlertElement(alert);
          
          // æ¸…é™¤"ç­‰å¾…æŠ¥è­¦æ•°æ®"æç¤º
          const noAlertsElement = alertContainer.querySelector('.no-alerts');
          if (noAlertsElement) {
            noAlertsElement.remove();
          }
          
          // æ·»åŠ åˆ°å®¹å™¨é¡¶éƒ¨
          if (alertContainer) {
            alertContainer.insertBefore(alertElement, alertContainer.firstChild);
            
            // å¦‚æœæŠ¥è­¦å¤ªå¤šï¼Œç§»é™¤æ—§çš„
            while (alertContainer.children.length > MAX_ALERTS) {
              alertContainer.removeChild(alertContainer.lastChild);
            }
          }
          
          // ğŸ”§ ä¿®å¤ï¼šåŸºäºå®é™…æ˜¾ç¤ºçš„æŠ¥è­¦å…ƒç´ æ•°é‡æ›´æ–°è®¡æ•°
          const currentAlertElements = alertContainer.querySelectorAll('.alert-item');
          alertCount = currentAlertElements.length;
          if (alertCountElement) {
            alertCountElement.textContent = alertCount;
          }
          
          console.log(`ğŸ“Š å®æ—¶æŠ¥è­¦å·²æ·»åŠ ï¼Œå½“å‰æ˜¾ç¤º ${alertCount} æ¡æŠ¥è­¦`);
          
          // æ’­æ”¾å£°éŸ³æç¤º
          playAlertSound();
        }

        // åˆ›å»ºæŠ¥è­¦å…ƒç´ 
        function createAlertElement(alert) {
          const alertDiv = document.createElement('div');
          alertDiv.className = 'alert-item';
          alertDiv.dataset.alertId = alert.id;
          alertDiv.dataset.cameraId = alert.camera_id;
          alertDiv.dataset.alertType = alert.alert_type;
          
          // è®¾ç½®æŠ¥è­¦ç±»å‹æ ·å¼
          alertDiv.classList.add(`alert-type-${alert.alert_type}`);
          
          // æ ¼å¼åŒ–æ—¶é—´
          const alertTime = new Date(alert.timestamp);
          const formattedTime = alertTime.toLocaleString('zh-CN');
          
          // è·å–æŠ¥è­¦ç±»å‹æ˜¾ç¤ºæ–‡æœ¬
          const alertTypeText = ALERT_TYPES[alert.alert_type] || alert.alert_type;
          
          // æ„å»ºHTMLå†…å®¹
          alertDiv.innerHTML = `
            <div class="alert-header">
              <span class="alert-type">${alertTypeText}</span>
              <span class="alert-time">${formattedTime}</span>
            </div>
            <div class="alert-body">
              <div class="alert-info">
                <p><strong>ID:</strong> ${alert.id || 'æœªçŸ¥'}</p>
                <p><strong>æŠ¥è­¦åç§°:</strong> ${alert.alert_name || 'æœªçŸ¥'}</p>
                <p><strong>æŠ¥è­¦ç±»åˆ«:</strong> ${alert.alert_category || 'æœªåˆ†ç±»'}</p>
                <p><strong>æ‘„åƒå¤´:</strong> ${alert.camera_name || alert.camera_id}</p>
                <p><strong>ä½ç½®:</strong> ${alert.location || 'æœªçŸ¥'}</p>
                <p><strong>æŠ¥è­¦ç­‰çº§:</strong> ${alert.alert_level || 1}</p>
                <p><strong>ç½®ä¿¡åº¦:</strong> ${alert.confidence ? (alert.confidence * 100).toFixed(2) + '%' : 'æœªçŸ¥'}</p>
              </div>
              <div class="alert-image">
                <img src="${alert.minio_frame_url || '/static/img/no-image.png'}" alt="æŠ¥è­¦æˆªå›¾" onerror="this.src='/static/img/no-image.png'">
              </div>
            </div>
            <div class="alert-footer">
              <a href="${alert.minio_video_url || '#'}" target="_blank" class="alert-video-link">æŸ¥çœ‹è§†é¢‘</a>
              <button class="alert-dismiss" onclick="dismissAlert(this.parentNode.parentNode)">å¿½ç•¥</button>
            </div>
          `;
          
          return alertDiv;
        }

        // æ’­æ”¾æŠ¥è­¦å£°éŸ³
        function playAlertSound() {
          const audio = document.getElementById('alert-sound');
          if (audio) {
            audio.play().catch(error => {
              // å¿½ç•¥ç”¨æˆ·äº¤äº’é™åˆ¶å¯¼è‡´çš„é”™è¯¯
              console.log('æ— æ³•æ’­æ”¾å£°éŸ³:', error);
            });
          }
        }

        // å¿½ç•¥æŠ¥è­¦
        function dismissAlert(alertElement) {
          if (alertElement && alertElement.parentNode) {
            alertElement.parentNode.removeChild(alertElement);
            
            // ğŸ”§ ä¿®å¤ï¼šç§»é™¤æŠ¥è­¦åæ›´æ–°è®¡æ•°
            const currentAlertElements = alertContainer.querySelectorAll('.alert-item');
            alertCount = currentAlertElements.length;
            if (alertCountElement) {
              alertCountElement.textContent = alertCount;
            }
            
            console.log(`ğŸ“Š æŠ¥è­¦å·²å¿½ç•¥ï¼Œå½“å‰æ˜¾ç¤º ${alertCount} æ¡æŠ¥è­¦`);
            
            // å¦‚æœæ²¡æœ‰æŠ¥è­¦äº†ï¼Œæ˜¾ç¤ºæç¤º
            if (alertCount === 0) {
              alertContainer.innerHTML = '<div class="no-alerts"><p>æš‚æ— æŠ¥è­¦æ•°æ®</p></div>';
            }
          }
        }

        // è¿‡æ»¤æŠ¥è­¦
        function filterAlerts() {
          const cameraId = cameraFilter ? cameraFilter.value : '';
          const alertType = alertTypeFilter ? alertTypeFilter.value : '';
          
          // éå†æ‰€æœ‰æŠ¥è­¦å…ƒç´ 
          const alerts = alertContainer.getElementsByClassName('alert-item');
          for (let i = 0; i < alerts.length; i++) {
            const alert = alerts[i];
            let visible = true;
            
            // æŒ‰æ‘„åƒå¤´è¿‡æ»¤
            if (cameraId && alert.dataset.cameraId !== cameraId) {
              visible = false;
            }
            
            // æŒ‰æŠ¥è­¦ç±»å‹è¿‡æ»¤
            if (alertType && alert.dataset.alertType !== alertType) {
              visible = false;
            }
            
            // è®¾ç½®å¯è§æ€§
            alert.style.display = visible ? 'block' : 'none';
          }
        }

        // åŠ è½½å†å²æŠ¥è­¦æ•°æ®
        async function loadHistoricalAlerts() {
          try {
            showStatusMessage('æ­£åœ¨åŠ è½½å†å²æŠ¥è­¦...', 'info');
            
            const response = await fetch('/api/v1/alerts/real-time?limit=20');
            if (!response.ok) {
              throw new Error('è·å–å†å²æŠ¥è­¦å¤±è´¥');
            }
            
            const data = await response.json();
            const alerts = data.alerts || [];
            
            console.log('ğŸ“Š åŠ è½½æŠ¥è­¦æ•°æ®:', {
              loaded_alerts: alerts.length,
              total_in_db: data.total,
              pages: data.pages,
              current_page: data.page
            });
            
            // æ¸…ç©ºå®¹å™¨
            if (alertContainer) {
              alertContainer.innerHTML = '';
            }
            
            if (alerts.length === 0) {
              alertContainer.innerHTML = '<div class="no-alerts"><p>æš‚æ— æŠ¥è­¦æ•°æ®</p></div>';
              // ğŸ”§ ä¿®å¤ï¼šæ²¡æœ‰æ•°æ®æ—¶ï¼Œæ˜¾ç¤ºè®°å½•æ•°ä¸º0
              alertCount = 0;
              if (alertCountElement) {
                alertCountElement.textContent = 0;
              }
              showStatusMessage('æš‚æ— æŠ¥è­¦æ•°æ®', 'info');
            } else {
              // æ·»åŠ æŠ¥è­¦
              alerts.forEach(alert => {
                const alertElement = createAlertElement(alert);
                alertContainer.appendChild(alertElement);
              });
              
              // ğŸ”§ ä¿®å¤ï¼šæ˜¾ç¤ºå½“å‰é¡µé¢åŠ è½½çš„è®°å½•æ•°ï¼Œè€Œä¸æ˜¯æ•°æ®åº“æ€»æ•°
              alertCount = alerts.length;
              if (alertCountElement) {
                alertCountElement.textContent = alerts.length;
              }
              
              // ğŸ”§ ä¿®å¤ï¼šçŠ¶æ€æ¶ˆæ¯æ˜¾ç¤ºæ›´è¯¦ç»†çš„ä¿¡æ¯
              const totalRecords = data.total || alerts.length;
              const statusMsg = totalRecords > alerts.length 
                ? `åŠ è½½å®Œæˆï¼Œæ˜¾ç¤ºæœ€æ–° ${alerts.length} æ¡è®°å½•ï¼ˆæ•°æ®åº“å…± ${totalRecords} æ¡ï¼‰`
                : `åŠ è½½å®Œæˆï¼Œå…± ${alerts.length} æ¡è®°å½•`;
              
              showStatusMessage(statusMsg, 'success');
              
              console.log(`âœ… æŠ¥è­¦æ•°æ®åŠ è½½å®Œæˆ: æ˜¾ç¤º${alerts.length}æ¡ï¼Œæ€»è®¡${totalRecords}æ¡`);
            }
            
          } catch (error) {
            console.error('åŠ è½½å†å²æŠ¥è­¦å¤±è´¥:', error);
            showStatusMessage('åŠ è½½å¤±è´¥: ' + error.message, 'error');
            
            // ğŸ”§ ä¿®å¤ï¼šå‡ºé”™æ—¶é‡ç½®è®¡æ•°å™¨
            alertCount = 0;
            if (alertCountElement) {
              alertCountElement.textContent = 0;
            }
          }
        }

        // å‘é€æµ‹è¯•æŠ¥è­¦
        async function sendTestAlert() {
          const button = document.getElementById('send-test-alert');
          const originalText = button.innerHTML;
          
          try {
            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            button.disabled = true;
            button.innerHTML = '<span class="loading"></span>å‘é€ä¸­...';
            
            showStatusMessage('æ­£åœ¨å‘é€æµ‹è¯•æŠ¥è­¦...', 'info');
            console.log('å‘é€æµ‹è¯•æŠ¥è­¦è¯·æ±‚, è¿æ¥ID:', connectionId);
            
            const response = await fetch('/api/v1/alerts/test', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              }
            });
            
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            console.log('æµ‹è¯•æŠ¥è­¦å‘é€æˆåŠŸ:', result);
            
            showStatusMessage('âœ… æµ‹è¯•æŠ¥è­¦å‘é€æˆåŠŸï¼', 'success');
            
          } catch (error) {
            console.error('å‘é€æµ‹è¯•æŠ¥è­¦å¤±è´¥:', error);
            showStatusMessage('âŒ å‘é€å¤±è´¥: ' + error.message, 'error');
          } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            button.disabled = false;
            button.innerHTML = originalText;
          }
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatusMessage(message, type) {
          if (statusMessage) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;
            statusMessage.style.display = 'inline-block';
            
            // 3ç§’åè‡ªåŠ¨éšè—æˆåŠŸæ¶ˆæ¯
            if (type === 'success') {
              setTimeout(() => {
                statusMessage.style.display = 'none';
              }, 3000);
            }
          }
        }

        // æ£€æŸ¥SSEè¿æ¥çŠ¶æ€
        async function checkSSEStatus() {
          try {
            showStatusMessage('æ­£åœ¨æ£€æŸ¥SSEè¿æ¥çŠ¶æ€...', 'info');
            
            // æ£€æŸ¥æœåŠ¡å™¨ç«¯çš„è¿æ¥ç»Ÿè®¡
            const response = await fetch('/api/v1/alerts/sse/status');
            if (!response.ok) {
              throw new Error('è·å–æœåŠ¡å™¨SSEçŠ¶æ€å¤±è´¥');
            }
            
            const data = await response.json();
            console.log('æœåŠ¡å™¨SSEçŠ¶æ€:', data);
            
            // æ£€æŸ¥å®¢æˆ·ç«¯è¿æ¥çŠ¶æ€
            const clientStatus = eventSource ? 
              (eventSource.readyState === EventSource.OPEN ? 'å·²è¿æ¥' : 
               eventSource.readyState === EventSource.CONNECTING ? 'è¿æ¥ä¸­' : 'å·²æ–­å¼€') : 'æœªè¿æ¥';
            
            // æ„å»ºè¯¦ç»†çŠ¶æ€ä¿¡æ¯
            const statusInfo = {
              client: {
                status: clientStatus,
                connectionId: connectionId,
                readyState: eventSource ? eventSource.readyState : null,
                isConnecting: isConnecting,
                hasReconnectTimeout: !!reconnectTimeout
              },
              server: data,
              stats: connectionStats,
              page: {
                hidden: document.hidden,
                url: window.location.href,
                userAgent: navigator.userAgent.substring(0, 100)
              }
            };
            
            console.log('ğŸ” å®Œæ•´è¿æ¥çŠ¶æ€:', statusInfo);
            
            const statusText = `ğŸ–¥ï¸ å®¢æˆ·ç«¯: ${clientStatus} | ğŸŒ æœåŠ¡å™¨: ${data.connected_clients} ä¸ªè¿æ¥ | ğŸ“Š æ€»è¿æ¥: ${connectionStats.totalConnections} æ¬¡`;
            showStatusMessage(statusText, 'success');
            
            // å¦‚æœè¿æ¥å¼‚å¸¸é¢‘ç¹ï¼Œç»™å‡ºè­¦å‘Š
            if (connectionStats.totalConnections > 10) {
              console.warn('âš ï¸ æ£€æµ‹åˆ°å¼‚å¸¸é¢‘ç¹çš„è¿æ¥ï¼è¿æ¥ç»Ÿè®¡:', connectionStats);
              showStatusMessage(`âš ï¸ è­¦å‘Šï¼šæ£€æµ‹åˆ° ${connectionStats.totalConnections} æ¬¡è¿æ¥ï¼Œå¯èƒ½å­˜åœ¨é—®é¢˜`, 'error');
            }
            
          } catch (error) {
            console.error('æ£€æŸ¥SSEè¿æ¥çŠ¶æ€å¤±è´¥:', error);
            showStatusMessage('âŒ æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
          }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
          // ç¡®ä¿åªåˆå§‹åŒ–ä¸€æ¬¡
          if (window.alertMonitorInitialized) {
            console.log('æŠ¥è­¦ç›‘æ§å·²ç»åˆå§‹åŒ–ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');
            return;
          }
          
          window.alertMonitorInitialized = true;
          initAlertMonitor();
        });
    </script>
</body>
</html> 