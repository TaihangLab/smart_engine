# 智能视觉引擎系统架构

## 系统架构图

```
+-------------------+    +-------------------+    +-------------------+
|                   |    |                   |    |                   |
|  WVP视频平台服务   |--->|  Smart Vision引擎  |--->|  Triton推理服务器  |
|                   |    |                   |    |                   |
+-------------------+    +-------------------+    +-------------------+
                              |        ^
                              |        |
                              v        |
+-------------------+    +-------------------+
|                   |    |                   |
|     数据库存储     |<-->|     前端界面      |
|   (MySQL/关系型)   |    |  (Web应用界面)    |
|                   |    |                   |
+-------------------+    +-------------------+


+-----------------------------------------------------------------+
|                                                                 |
|                        Smart Vision引擎                          |
|                                                                 |
|  +----------------+  +---------------+  +-------------------+   |
|  |                |  |               |  |                   |   |
|  |   摄像头管理    |  |   技能管理     |  |     模型管理      |   |
|  |                |  |               |  |                   |   |
|  +----------------+  +---------------+  +-------------------+   |
|  +----------------+  +---------------+  +-------------------+   |
|  |                |  |               |  |                   |   |
|  |   任务调度      |  |   技能工厂     |  |    结果处理       |   |
|  |                |  |               |  |                   |   |
|  +----------------+  +---------------+  +-------------------+   |
|                                                                 |
+-----------------------------------------------------------------+
```

## 核心概念

### 摄像头 (Camera)

摄像头是视频流的数据源，系统通过与WVP视频平台对接来管理和获取摄像头视频流。每个摄像头包含以下核心属性：
- ID和名称：唯一标识和友好显示名
- 位置信息：安装位置和坐标
- RTSP流地址：视频流的访问地址
- 状态：是否在线、启用状态
- 标签：用于分类和筛选

摄像头与AI任务是一对多的关系，一个摄像头可以绑定多个AI任务。

### 技能类 (SkillClass)

技能类是系统中对AI能力的抽象，每种技能类代表一种特定的AI视觉分析能力，例如目标检测、人脸识别等。技能类具有以下特点：
- 名称和类型：如"安全帽检测"，类型为"检测"
- 描述：技能的详细说明
- 关联模型：技能依赖的AI模型列表
- 默认配置：技能的默认参数设置
- Python类：对应的实现类，用于加载和运行技能

技能类是可扩展的，系统支持动态加载新的技能类实现。

### 模型 (Model)

模型是AI推理的核心组件，代表已部署在Triton推理服务器上的深度学习模型。模型包含：
- 名称和版本：模型标识
- 状态：是否可用
- 配置信息：模型参数、输入输出定义等
- Triton配置：在Triton服务器上的部署配置

模型与技能类是多对多关系，一个模型可以被多个技能类使用，一个技能类也可以使用多个模型。

### AI任务 (AITask)

AI任务是将摄像头、技能类组合起来执行实际分析的工作单元。AI任务定义了：
- 关联的摄像头：数据来源
- 使用的技能类：处理逻辑的类型
- 任务配置：如抽帧频率、运行时段等
- 技能配置：覆盖技能类默认配置的特定参数
- 特殊设置：如电子围栏、预警等级等
- 任务状态：是否启用

AI任务是系统的核心执行单元，由调度系统负责启动、监控和管理。每个任务执行时会动态创建技能对象，使用合并后的配置进行处理。

## 系统工作流程

1. **摄像头注册与管理**：系统从WVP平台同步摄像头信息，或手动添加摄像头。

2. **模型部署与同步**：AI模型部署到Triton服务器后，系统自动同步模型信息到数据库。

3. **技能注册**：系统启动时，扫描并注册所有实现了BaseSkill接口的技能类。

4. **AI任务创建**：用户选择摄像头和技能类，配置任务参数和技能配置，创建AI任务。

5. **任务执行**：调度系统根据配置启动任务，从摄像头获取视频流，动态创建技能对象并合并配置，处理视频帧得到分析结果。

6. **结果处理**：分析结果存储到数据库，并通过API或消息队列向外部系统通知。

## 配置合并机制

系统采用深度配置合并机制，确保技能执行时拥有完整且准确的配置：

```
技能类默认配置 + 任务技能配置 = 最终执行配置
```

### 合并规则
- **递归合并**：对于嵌套的字典结构，会递归进行深度合并
- **任务优先**：任务级别的配置会覆盖技能类的默认配置
- **保持完整**：确保所有必要的配置项都存在

### 示例
```json
// 技能类默认配置
{
  "params": {
    "conf_thres": 0.5,
    "iou_thres": 0.45,
    "max_det": 300,
    "classes": ["hat", "person"]
  },
  "model": {
    "device": "cuda",
    "half": true
  }
}

// 任务技能配置
{
  "params": {
    "conf_thres": 0.7,
    "max_det": 500
  }
}

// 合并后的最终配置
{
  "params": {
    "conf_thres": 0.7,      // 被任务配置覆盖
    "iou_thres": 0.45,      // 保留默认值
    "max_det": 500,         // 被任务配置覆盖
    "classes": ["hat", "person"]  // 保留默认值
  },
  "model": {               // 完整保留
    "device": "cuda",
    "half": true
  }
}
```

## 技术实现

系统基于FastAPI框架开发，采用SQLAlchemy作为ORM层，与MySQL数据库交互。系统采用模块化设计，各组件之间通过明确的接口进行交互，确保系统的可扩展性和可维护性。

### 数据流

```
视频流 → 抽帧 → 前处理 → AI推理 → 后处理 → 结果输出 → 数据存储/前端展示
```

### 核心模块

- **API层**：提供RESTful接口，支持所有管理操作
- **服务层**：实现业务逻辑，协调各组件
- **DAO层**：负责数据访问，与数据库交互
- **技能系统**：插件式架构，支持自定义技能
- **调度系统**：管理任务生命周期，确保任务稳定运行

### 架构优势

1. **简化的层次结构**：移除技能实例中间层，直接从技能类到任务执行
2. **更高的配置灵活性**：任务级别的配置可以精确控制技能行为
3. **更好的性能**：按需创建技能对象，避免不必要的内存占用
4. **更低的维护成本**：减少了中间层的复杂性和管理开销 