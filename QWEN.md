# Smart Vision Engine - QWEN.md

## 项目概述

Smart Vision Engine 是一个基于WVP（Web Video Platform）的智能视觉AI平台后端服务，提供摄像头管理、AI技能管理、任务调度和实时预警等功能。该系统专注于安防领域的智能视频分析，支持多种AI技能插件，具备强大的实时预警和任务调度能力。

## 知识库
[.wiki](./.wiki/README.md)为当前项目的知识库的索引，可以通过改知识库快速定位和了解项目，并针对性的进行代码变动。


### 核心功能
- **摄像头管理**：支持从WVP同步设备，配置摄像头属性（位置、标签、预警等级等）
- **技能管理**：支持创建和管理视觉AI技能，插件式架构，支持热加载
- **AI任务管理**：支持创建AI分析任务，直接使用技能类+自定义配置的灵活模式
- **智能任务调度**：基于APScheduler的精确时段调度，支持多时段配置和自动恢复
- **智能预警合并系统**：基于MD5去重的预警合并机制，支持分级延时发送和预警视频录制
- **分级视频录制**：根据预警等级自动生成不同长度的预警视频，1级预警支持异步处理
- **实时预警系统**：支持4级预警体系（1级最高，4级最低），实时生成预警信息和截图
- **电子围栏**：支持多边形区域定义，智能过滤围栏内外的检测结果
- **模型管理**：支持管理Triton推理服务器上的模型，自动同步模型到数据库
- **技能模块化**：采用插件式技能架构，可以轻松扩展新的视觉分析能力
- **技能热加载**：支持动态加载技能插件，无需重启系统
- **异步预警处理**：预警生成采用异步机制，不阻塞视频处理主流程
- **MinIO存储**：预警图片和视频自动上传至MinIO，支持按任务ID分类存储
- **RabbitMQ消息队列**：支持预警消息队列处理和补偿机制
- **SSE实时通信**：支持Server-Sent Events实时推送预警信息
- **系统监控**：提供健康检查接口，监控系统和依赖服务状态
- **目标跟踪**：集成SORT算法，支持多目标跟踪，避免重复计数
- **智能自适应帧读取**：基于连接开销智能选择连续流模式或按需截图模式，自动优化资源使用
- **高性能视频流处理**：采用多线程视频处理，确保AI分析使用最新帧数据，减少延迟
- **异步队列架构**：三层解耦设计（采集→检测→推流），支持独立的帧率控制和智能丢帧
- **RTSP检测结果推流**：可选的FFmpeg RTSP推流功能，实时推送带检测框的视频流
- **内存优化**：减少不必要的帧拷贝，智能检测框绘制，大幅降低内存使用
- **多模态大模型技能**：支持LLM多模态视觉分析，用于复杂场景的智能预判
- **智能复判系统**：基于Redis队列的可靠复判架构，支持多工作者并发处理
- **LLM服务集成**：集成Ollama本地大模型服务，支持llava、qwen等多模态模型
- **多模态大模型复判系统**：支持基于Ollama的多模态大模型复判功能，提供智能的预警二次确认机制

### 技术架构
- **Web框架**：FastAPI
- **数据库ORM**：SQLAlchemy
- **推理服务**：Triton Inference Server
- **数据库**：MySQL（支持其他SQLAlchemy兼容数据库）
- **任务调度**：APScheduler（支持Cron表达式）
- **对象存储**：MinIO
- **消息队列**：RabbitMQ
- **实时通信**：Server-Sent Events (SSE)
- **技能系统**：插件式架构，支持动态加载
- **目标跟踪**：SORT (Simple Online and Realtime Tracking)
- **视频流处理**：智能自适应帧读取 + 多线程视频读取架构
- **异步队列**：Python Queue + 多线程架构
- **预警合并**：基于时间窗口和MD5去重的智能合并算法
- **视频编码**：OpenCV + FFmpeg，支持H.264/MP4格式
- **多模态大模型**：Ollama + llava/qwen多模态视觉模型
- **复判队列**：Redis消息队列，支持任务持久化和故障恢复
- **图像处理**：OpenCV
- **数值计算**：NumPy
- **性能监控**：内置统计模块

## 架构组件

### 主要目录结构
```
app/
├── api/                    # API路由和端点
├── core/                   # 核心配置和工具
├── db/                     # 数据库相关代码
├── models/                 # 数据模型定义
├── plugins/                # 插件目录
│   └── skills/             # 技能插件
├── services/               # 业务服务层
├── skills/                 # 技能系统核心
└── main.py                 # 应用入口点
```

### 核心服务
1. **AI任务执行器** (`ai_task_executor.py`) - 基于精确调度的AI任务执行器，支持多线程视频处理和智能帧率控制
2. **预警服务** (`alert_service.py`) - 优化后的报警服务，支持RabbitMQ消息队列和SSE实时推送
3. **系统启动服务** (`system_startup.py`) - 零配置企业级启动管理，自动初始化所有服务
4. **预警合并管理器** - 基于时间窗口和MD5去重的智能预警合并系统
5. **复判队列服务** - 基于Redis的可靠复判架构，支持多工作者并发处理

### 技能系统
系统采用插件式技能架构，支持多种AI技能：
- 安全帽检测
- 安全带检测
- 口罩检测
- 救生衣检测
- 绝缘手套检测
- 工作服检测
- 打电话检测
- 玩手机检测
- 睡岗检测
- 煤矿工人行为检测
- 人员超限检测
- 人员聚集检测
- COCO对象检测
- 手机检测
- 车牌识别

## 构建和运行

### 环境准备
```bash
# 克隆项目
git clone <repository-url>
cd smart_engine

# 创建虚拟环境（推荐使用conda）
conda create -n smart_engine python=3.11.9
conda activate smart_engine

# 安装依赖
pip install -r requirements.txt
```

### 中文字体安装（Linux系统推荐）
为了在Linux系统上正确显示车牌识别等技能的中文信息，建议安装中文字体：
```bash
# Ubuntu/Debian系统
sudo apt-get update
sudo apt-get install -y fonts-wqy-microhei fonts-wqy-zenhei fonts-noto-cjk

# 刷新字体缓存
sudo fc-cache -fv
```

### FFmpeg安装（RTSP推流功能需要）
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install ffmpeg

# CentOS/RHEL
sudo yum install ffmpeg

# macOS (使用Homebrew)
brew install ffmpeg
```

### 配置文件
系统配置在 `app/core/config.py` 中管理，主要配置项包括：
- 数据库配置（MySQL）
- Triton推理服务器配置
- MinIO对象存储配置
- RabbitMQ消息队列配置
- WVP平台配置
- 预警合并配置
- LLM服务配置
- Redis配置（复判队列）

### 数据库初始化
```bash
python -c "
from app.db.session import engine
from app.db.base_class import Base
Base.metadata.create_all(bind=engine)
print('数据库表创建完成')
"
```

### 运行
```bash
# 开发模式
python -m app.main

# 生产模式
uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4
```

访问API文档：http://localhost:8000/docs

## 开发规范

### 代码风格
- 遵循PEP 8 Python代码风格指南
- 使用类型注解提高代码可读性
- 适当的日志记录，便于调试和监控

### 测试实践
- 使用pytest进行单元测试
- 为新功能编写相应的测试用例
- 遵循测试驱动开发(TDD)原则

### 贡献指南
- 提交代码前确保所有测试通过
- 遵循项目的分支管理策略
- 为重要的变更提供详细的提交信息
- 在PR中说明变更的目的和影响

## 特殊功能说明

### 预警合并系统
系统采用先进的预警合并算法，有效减少预警噪音，提高处理效率：
- MD5唯一键：基于任务ID、摄像头ID、技能类型、预警等级生成唯一标识
- 智能合并窗口：相同预警在设定时间内自动合并
- 分级延时发送策略：根据预警等级设置不同的延迟时间

### 多模态大模型复判系统
系统集成了基于Ollama的多模态大模型复判功能，提供智能的预警二次确认机制：
- 支持图像+文本的复合分析
- 支持定义输出参数，大模型返回标准JSON格式结果
- 基于Redis的可靠复判队列，支持任务持久化和故障恢复

### 分级视频录制系统
根据预警等级自动生成不同规格的预警视频：
- 1-2级关键预警：前5秒 + 后5秒缓冲，总时长最长40秒
- 3-4级普通预警：前3秒 + 后3秒缓冲，总时长最长21秒
- 支持同步和异步两种视频生成模式

### 智能自适应帧读取系统
- 连接开销评估：实时计算流连接建立时间，动态选择最优模式
- 连续流模式：适用于高频检测，使用ThreadedFrameReader连续读取
- 按需截图模式：适用于低频检测，通过WVP API按需获取快照
- 自动切换：根据网络状况和检测频率自动在两种模式间切换